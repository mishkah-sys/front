<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† - Ù…Ø´ÙƒØ§Ø©</title>
  <!-- Mishkah Core -->
  <script src="../mishkah-utils.js"></script>
  <script src="../mishkah.core.js"></script>
  <script src="../mishkah-ui.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#64748b'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-50 min-h-screen p-8 text-gray-800 font-sans">
  <div id="app"></div>

  <script>
    // Ø§Ù„Ø§Ø®ØªØµØ§Ø±Ø§Øª
    const D = Mishkah.DSL;
    const UI = Mishkah.UI;

    // 1. Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Database)
    const database = {
      data: {
        // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠØ©
        employees: [
          { id: 1, name: 'Ø¥Ø³Ø±Ø§Ø¡ Ø¬Ø§Ø¨Ø±', role: 'Ù…Ø¯ÙŠØ± ØªÙ†ÙÙŠØ°ÙŠ' },
          { id: 2, name: 'Ø¹ØµØ§Ù… Ø¬Ù…Ø¹Ø©', role: 'Ù…Ø¯ÙŠØ± ØªÙ‚Ù†ÙŠ' },
          { id: 3, name: 'Ù…Ø­Ù…Ø¯ Ø´Ù‡Ø§Ø¨', role: 'Ù…Ø¯ÙŠØ± Ù…Ø§Ù„ÙŠ' },
          { id: 4, name: 'Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯', role: 'Ù…ØµÙ…Ù… ÙˆØ§Ø¬Ù‡Ø§Øª' },
          { id: 5, name: 'Ø­Ø³ÙŠÙ† ÙØªØ­ÙŠ', role: 'Ù…Ù‡Ù†Ø¯Ø³ Ø¬ÙˆØ¯Ø©' }
        ],
        // Ø­Ø§Ù„Ø© Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
        newEmployeeName: '',
        newEmployeeRole: ''
      },
      env: {
        lang: 'ar',
        theme: 'light'
      },
      i18n: {
        dict: {} // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ù‡Ù†Ø§
      }
    };

    // 2. Ø§Ù„Ø£ÙˆØ§Ù…Ø± (Orders)
    const orders = {
      // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ø§Ø³Ù… Ø¹Ù†Ø¯ Ø§Ù„ÙƒØªØ§Ø¨Ø©
      'emp.input.name': {
        on: ['input'],
        gkeys: ['input:name'],
        handler: (e, ctx) => {
          ctx.setState(state => {
            const s = { ...state };
            s.data.newEmployeeName = e.target.value;
            return s;
          });
        }
      },

      // ØªØ­Ø¯ÙŠØ« Ù†Øµ Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ
      'emp.input.role': {
        on: ['input'],
        gkeys: ['input:role'],
        handler: (e, ctx) => {
          ctx.setState(state => {
            const s = { ...state };
            s.data.newEmployeeRole = e.target.value;
            return s;
          });
        }
      },

      // Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯
      'emp.add': {
        on: ['click'],
        gkeys: ['btn:add'],
        handler: (e, ctx) => {
          ctx.setState(state => {
            if (!state.data.newEmployeeName.trim()) {
              alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù');
              return state;
            }
            if (!state.data.newEmployeeRole.trim()) {
              alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ');
              return state;
            }

            const s = { ...state };
            const newEmp = {
              id: Date.now(),
              name: s.data.newEmployeeName,
              role: s.data.newEmployeeRole
            };

            s.data.employees = [...s.data.employees, newEmp];
            s.data.newEmployeeName = '';
            s.data.newEmployeeRole = ''; // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚Ù„
            return s;
          });
        }
      },

      // Ø­Ø°Ù Ù…ÙˆØ¸Ù
      'emp.delete': {
        on: ['click'],
        gkeys: ['btn:delete'],
        handler: (e, ctx) => {
          // Ù†Ø³ØªØ®Ø¯Ù… data-id Ø§Ù„Ù…Ø®Ø²Ù† ÙÙŠ Ø§Ù„Ø²Ø±
          const id = Number(e.target.dataset.id);
          if (!id) return;

          ctx.setState(state => {
            if (!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) return state;
            const s = { ...state };
            s.data.employees = s.data.employees.filter(emp => emp.id !== id);
            return s;
          });
        }
      },

      // Ø¹Ø±Ø¶ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      'sys.debug': {
        on: ['click'],
        gkeys: ['btn:debug'],
        handler: (e, ctx) => {
          console.log('Current Database:', ctx.getState());
          alert(JSON.stringify(ctx.getState(), null, 2));
        }
      }
    };

    // 3. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (DSL Body)
    function body(db) {

      // Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©
      const header = D.header({ attrs: { class: 'mb-8 text-center' } }, [
        D.h1({ attrs: { class: 'text-4xl font-bold text-primary mb-2' } }, ['Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†']),
        D.p({ attrs: { class: 'text-secondary' } }, ['ÙØ±ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ù…ÙŠØ²'])
      ]);

      // Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
      const addForm = D.div({ attrs: { class: 'bg-white p-6 rounded-xl shadow-md mb-8 flex gap-4 items-end' } }, [
        // Ø­Ù‚Ù„ Ø§Ù„Ø§Ø³Ù…
        D.div({ attrs: { class: 'flex-1' } }, [
          D.label({ attrs: { class: 'block text-sm font-medium mb-1' } }, ['Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù']),
          D.input({
            attrs: {
              class: 'w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none',
              placeholder: 'Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…...',
              value: db.data.newEmployeeName,
              gkey: 'input:name'
            }
          })
        ]),
        // Ø­Ù‚Ù„ Ø§Ù„ÙˆØ¸ÙŠÙØ©
        D.div({ attrs: { class: 'flex-1' } }, [
          D.label({ attrs: { class: 'block text-sm font-medium mb-1' } }, ['Ø§Ù„Ù…Ø³Ù…Ù‰ Ø§Ù„ÙˆØ¸ÙŠÙÙŠ']),
          D.input({
            attrs: {
              class: 'w-full p-2 border rounded-lg focus:ring-2 focus:ring-primary outline-none',
              placeholder: 'ÙˆØ¸ÙŠÙØ© Ø§Ù„Ù…ÙˆØ¸Ù...',
              value: db.data.newEmployeeRole,
              gkey: 'input:role'
            }
          })
        ]),
        // Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        D.button({
          attrs: {
            class: 'bg-primary text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition font-bold h-[42px]',
            gkey: 'btn:add'
          }
        }, ['Ø¥Ø¶Ø§ÙØ© +'])
      ]);

      // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
      const listItems = db.data.employees.map(emp => {
        return D.div({
          attrs: { class: 'flex items-center justify-between p-4 bg-white border-b last:border-0 hover:bg-gray-50 transition' }
        }, [
          // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù
          D.div({ attrs: { class: 'flex items-center gap-4' } }, [
            // Ø£ÙŠÙ‚ÙˆÙ†Ø© / ØµÙˆØ±Ø© Ø±Ù…Ø²ÙŠØ©
            D.div({ attrs: { class: 'w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-primary font-bold' } }, [
              emp.name.charAt(0) // Ø§Ù„Ø­Ø±Ù Ø§Ù„Ø£ÙˆÙ„
            ]),
            D.div({}, [
              D.h3({ attrs: { class: 'font-bold' } }, [emp.name]),
              D.span({ attrs: { class: 'text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full' } }, [emp.role])
            ])
          ]),

          // Ø²Ø± Ø§Ù„Ø­Ø°Ù
          D.button({
            attrs: {
              class: 'text-red-500 hover:bg-red-50 p-2 rounded-full transition w-8 h-8 flex items-center justify-center',
              gkey: 'btn:delete',
              'data-id': emp.id
            }
          }, ['âœ•'])
        ]);
      });

      const employeeList = D.div({ attrs: { class: 'bg-white rounded-xl shadow-lg overflow-hidden' } },
        listItems.length ? listItems : [
          D.div({ attrs: { class: 'p-8 text-center text-gray-400' } }, ['Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ¸ÙÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹'])
        ]
      );

      // Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Debug)
      const debugBtn = D.button({
        attrs: {
          class: 'fixed bottom-4 left-4 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg text-sm hover:bg-black transition z-50',
          gkey: 'btn:debug'
        }
      }, ['ğŸ” Ø¹Ø±Ø¶ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª']);

      return D.div({ attrs: { class: 'max-w-2xl mx-auto' } }, [
        header,
        addForm,
        employeeList,
        debugBtn
      ]);
    }

    // ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    Mishkah.app.setBody(body);
    Mishkah.app.create(database, orders).mount('#app');

  </script>
</body>

</html>