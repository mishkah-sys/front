<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POS DB Test</title>
</head>
<body>
    <h1>اختبار قاعدة بيانات نقاط البيع التلقائي</h1>
    <p>افتح الكونسول في المتصفح لرؤية المخرجات.</p>

    <!-- Include Mishkah libraries -->
    <script src="../lib/mishkah.js"></script>
    <script src="../lib/mishkah.store.js"></script>
    <script src="../lib/mishkah.simple-store.js"></script>

    <script>
        (async () => {
            try {
                console.log('جاري جلب مخطط البيانات...');
                
                const response = await fetch( window.basedomain + '/api/branches/dar/modules/pos?include=schema');
                if (!response.ok) {
                    throw new Error(`فشل في جلب مخطط البيانات: ${response.status} ${response.statusText}`);
                }
                const moduleData = await response.json();
                const schema = moduleData;

                console.log('--- بنية البيانات المستلمة (للتحليل) ---');
                console.log(JSON.stringify(schema, null, 2));
                console.log('-----------------------------------------');

                if (!schema || typeof schema.tables !== 'object') {
                    throw new Error('لم يتم العثور على مخطط البيانات في الاستجابة أو أنه لا يحتوي على خاصية "tables" ككائن.');
                }

                console.log('تم تحميل مخطط البيانات بنجاح.');
                console.log('جاري إنشاء قاعدة البيانات باستخدام createDBAuto...');

                const db = window.createDBAuto(schema, [], {
                    branchId: 'dar',
                    moduleId: 'pos',
                    autoConnect: false 
                });

                console.log('تم إنشاء كائن قاعدة البيانات. الكائنات المتاحة:', Object.keys(db.list()));

                db.status(status => {
                    console.log('حالة الاتصال:', status);
                });

                console.log('جاري الاتصال بالمتجر...');
                await db.connect();
                console.log('تم الاتصال بنجاح.');

                const tableNames = Object.keys(schema.tables);

                console.log('جاري مراقبة جميع الجداول الموجودة في مخطط البيانات:', tableNames);

                // Watch all tables
                for (const tableName of tableNames) {
                    db.watch(tableName, (data, meta) => {
                        if (data.length > 0) {
                            console.log(`بيانات جدول ${meta.table} (${data.length} سجلات):`, data);
                        }
                    }, { immediate: true });
                }

                console.log('تم تحميل البيانات الأولية. في انتظار التحديثات الفورية...');

            } catch (error) {
                console.error('حدث خطأ في سكربت الاختبار:', error);
                document.body.innerHTML += `<pre style="color:red;">${error.stack}</pre>`;
            }
        })();
    </script>
</body>
</html>