<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
  <title>V2 (WebSocket) â€” Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨ÙŠØ¹ Ù„Ù„Ù…Ø·Ø§Ø¹Ù…</title>
  <style>
    :root { color-scheme: light dark; }
    html, body {
      height: 100%;
      min-height: 100vh;
      width: 100vw;
      margin: 0;
      overflow: hidden;
      background: var(--background, #0f1115);
    }
    body {
      font-family: "Tajawal", "Cairo", system-ui, sans-serif;
      touch-action: manipulation;
      display: flex;
      min-height: 100vh;
      width: 100vw;
    }
    #app {
      flex: 1 1 auto;
      min-height: 100vh;
      width: 100vw;
      display: flex;
    }
    .pos-shell { flex: 1 1 auto; width: 100vw; }
  </style>
  <script src="../lib/mishkah-utils.js"></script>
  <script src="../lib/mishkah.core.js"></script>
  <script src="../lib/mishkah-ui.js"></script>
  <script src="../lib/mishkah-schema.js"></script>
  <script src="../lib/mishkah.store.js"></script>
  <script src="../lib/mishkah.simple-store.js"></script>
  <script src="./pos-simple-loader.js"></script>
  <!-- âŒ pos-mini-db.js REMOVED - using pure mishkah-store -->
</head>
<body>
  <div id="app"></div>
  <script>
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
    console.log('ğŸ”¥ [POS V2] PURE MISHKAH-STORE (No pos-mini-db.js!) ğŸ”¥');
    console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

    const params = new URLSearchParams(window.location.search || '');
    const BRANCH_ID = (params.get('brname') || '').trim();
    const MODULE_ID = 'pos';

    if (BRANCH_ID) {
      window.__POS_BRANCH_ID__ = BRANCH_ID;
    }

    if (!BRANCH_ID) {
      document.body.innerHTML = `
        <main
          style="
            min-height: 100vh;
            display: grid;
            place-items: center;
            font-size: clamp(1.4rem, 4vw, 2.2rem);
            color: #f8fafc;
            text-align:center;
          "
        >
          ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ±Ø¹
        </main>
      `;
    } else {
      const status = {
        status: 'loading',
        startedAt: Date.now(),
        finishedAt: null,
        error: null,
        keys: [],
        branchId: BRANCH_ID
      };

      window.__POS_DATA_STATUS__ = status;

      // âœ… Direct mishkah-store initialization (like kds.js)
      (async function initPosV2() {
        try {
          console.log('ğŸ“¡ [POS V2] Fetching schema from /api/schema...');

          // 1. Fetch schema directly from API
          const schemaParams = new URLSearchParams({
            branch: BRANCH_ID,
            module: MODULE_ID
          });
          const schemaResponse = await fetch(window.basedomain+`/api/schema?${schemaParams.toString()}`);
          const schemaPayload = await schemaResponse.json();
          const moduleEntry = schemaPayload?.modules?.[MODULE_ID];

          if (!moduleEntry || !moduleEntry.schema) {
            throw new Error(`Schema for module "${MODULE_ID}" not found`);
          }

          console.log('âœ… [POS V2] Schema loaded:', moduleEntry.schema);
          window.__POS_MODULE_ENTRY__ = moduleEntry;

          // 2. Define tables to watch
          const tables = [
            // âœ… CRITICAL: order_header and order_line for static KDS tabs (prep, expo, handoff)
            'order_header',
            'order_line',
            'order_payment',
            'pos_shift',
            'menu_items',
            'menu_categories',
            'dining_tables',
            'delivery_drivers',
            'payment_methods',
            'customer_profiles',
            // âœ… Job order tables (for dynamic KDS station tabs)
            'job_order_header',
            'job_order_detail',
            'job_order_detail_modifier',
            'job_order_status_history',  // âœ… CRITICAL: for status tracking
            'job_order_batch',  // âœ… CRITICAL: for batch grouping in KDS
            'kitchen_sections',
            'category_sections'
          ];

          console.log('ğŸ”Œ [POS V2] Creating WebSocket connection with createDBAuto...');

          // 3. Use createDBAuto directly (no wrapper!)
          const db = window.createDBAuto(moduleEntry.schema, tables, {
            branchId: BRANCH_ID,
            moduleId: MODULE_ID,
            role: 'pos-v2',
            autoReconnect: true,
            historyLimit: 200,
            logger: console
          });

          window.__POS_DB__ = db;
          console.log('âœ… [POS V2] createDBAuto called, waiting for ready...');

          await db.ready();
          console.log('âœ… [POS V2] WebSocket ready!');

          // 4. Load initial data from REST API (for backward compatibility)
          const loadFromRestApi = async () => {
            try {
              console.log('ğŸ“¥ [POS V2] Loading initial data from REST API...');
              const tables = await window.loadPosData(BRANCH_ID, MODULE_ID);
              window.database = tables;
              status.status = Object.keys(tables).length > 0 ? 'ready' : 'idle';
              status.keys = Object.keys(tables);
              console.log('âœ… [POS V2] REST API data loaded:', Object.keys(tables));
            } catch (error) {
              console.error('âŒ [POS V2] REST API load failed:', error);
              window.database = {};
              status.status = 'error';
            }
          };

          await loadFromRestApi();
          status.finishedAt = Date.now();

          // 5. Setup watchers to update window.database in real-time
          const registeredNames = typeof db.getRegisteredNames === 'function'
            ? db.getRegisteredNames()
            : Object.keys(db.config?.objects || {});

          console.log('ğŸ‘€ [POS V2] Setting up watchers for:', registeredNames);

          registeredNames.forEach(name => {
            if (name === 'pos_database') return;
            db.watch(name, (rows, meta) => {
              const tableName = meta?.table || name;
              if (!window.database) window.database = {};
              window.database[tableName] = rows;
              // console.log(`ğŸ”„ [POS V2] Table "${tableName}" updated:`, rows.length, 'rows');
            });
          });

          // 6. Load posv2.js (with cache-busting timestamp)
          console.log('ğŸš€ [POS V2] Loading posv2.js...');
          const script = document.createElement('script');
          script.src = `./posv2.js?v=${Date.now()}`; // âœ… Force reload (bypass cache)
          document.head.appendChild(script);

        } catch (error) {
          console.error('âŒ [POS V2] Initialization failed:', error);
          window.database = {};
          status.status = 'error';
          status.error = error;
          status.finishedAt = Date.now();
        }
      })();
    }
  </script>
</body>
</html>
