<!DOCTYPE html>
<html lang="ar" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Brocker v2 - Simple & Direct</title>
    <meta name="description" content="ŸÜÿ≥ÿÆÿ© ŸÖÿ®ÿ≥ÿ∑ÿ© ŸÖŸÜ ŸÖŸÜÿµÿ© Brocker - Frontend ŸÖÿ®ÿßÿ¥ÿ± ÿ®ÿØŸàŸÜ localization" />
    <meta name="theme-color" content="#0f172a" />
    <link rel="manifest" href="/api/pwa/aqar/brocker/manifest.json" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      :root {
        color-scheme: dark;
      }
      :root[data-theme='dark'] {
        --brocker-body: #030712;
        --brocker-text: #e2e8f0;
      }
      :root[data-theme='light'] {
        color-scheme: light;
        --brocker-body: #f8fafc;
        --brocker-text: #0f172a;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: 'Cairo', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background: var(--brocker-body, #030712);
        color: var(--brocker-text, #e2e8f0);
        transition: background-color 0.2s ease, color 0.2s ease;
      }
      #app {
        min-height: 100vh;
      }
      .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
    </style>
    <!-- Load Mishkah libraries individually for better control -->
    <script src="../../lib/mishkah-utils.js"></script>
    <script src="../../lib/mishkah.core.js"></script>
    <script src="../../lib/mishkah-ui.js"></script>
    <script src="../../lib/mishkah-schema.js"></script>
    <script src="../../lib/mishkah.store.js"></script>
    <script src="../../lib/mishkah.simple-store.js"></script>
  </head>
  <body>
    <div id="app"></div>
    <script>
      // Initialize Brocker v2 with scaffold pattern (like pos.js)
      (async function initBrockerV2() {
        try {
          console.log('üöÄ [Brocker v2] Starting initialization...');

          // Get URL params
          const params = new URLSearchParams(window.location.search || '');
          const BRANCH_ID = params.get('branch') || params.get('branchId') || 'aqar';
          const MODULE_ID = params.get('module') || params.get('moduleId') || 'brocker';

          // Get language from preferences
          let currentLang = 'ar';
          try {
            const prefs = JSON.parse(localStorage.getItem('brocker:prefs:v2') || '{}');
            currentLang = prefs.lang || 'ar';
          } catch (e) {
            currentLang = 'ar';
          }

          // Fetch schema
          console.log('üì° [Brocker v2] Fetching schema from /api/schema...');
          const schemaParams = new URLSearchParams({
            branch: BRANCH_ID,
            module: MODULE_ID
          });
          const schemaResponse = await fetch(`/api/schema?${schemaParams.toString()}`);
          const schemaPayload = await schemaResponse.json();
          const moduleEntry = schemaPayload?.modules?.[MODULE_ID];

          if (!moduleEntry || !moduleEntry.schema) {
            throw new Error(`Schema for module "${MODULE_ID}" not found`);
          }

          console.log('‚úÖ [Brocker v2] Schema loaded');
          window.__BROCKER_MODULE_ENTRY__ = moduleEntry;
          window.__BROCKER_BRANCH_ID__ = BRANCH_ID;
          window.__BROCKER_MODULE_ID__ = MODULE_ID;

          // Define tables to watch
          const tables = [
            'listings',
            'listings_lang',
            'regions',
            'brokers',
            'units',
            'unit_types'
          ];

          console.log('üîå [Brocker v2] Creating WebSocket connection...');

          // Create WebSocket connection with window.createDBAuto
          if (typeof window.createDBAuto !== 'function') {
            throw new Error('window.createDBAuto is not available. Make sure mishkah.simple-store.js is loaded.');
          }

          const db = window.createDBAuto(moduleEntry.schema, tables, {
            branchId: BRANCH_ID,
            moduleId: MODULE_ID,
            role: 'brocker-v2',
            lang: currentLang,
            autoReconnect: true,
            historyLimit: 200,
            logger: console
          });

          window.__BROCKER_DB__ = db;
          console.log('‚úÖ [Brocker v2] createDBAuto called, waiting for ready...');

          await db.ready();
          console.log('‚úÖ [Brocker v2] WebSocket ready!');

          // Load app-v2.js dynamically (with cache-busting)
          console.log('üöÄ [Brocker v2] Loading app-v2.js...');
          const script = document.createElement('script');
          script.src = `./app-v2.js?v=${Date.now()}`;
          document.head.appendChild(script);

        } catch (error) {
          console.error('‚ùå [Brocker v2] Initialization failed:', error);
          document.body.innerHTML = `
            <div style="
              min-height: 100vh;
              display: grid;
              place-items: center;
              font-size: 1.5rem;
              color: #ef4444;
              text-align: center;
              padding: 2rem;
            ">
              <div>
                <h1 style="font-size: 2rem; margin-bottom: 1rem;">‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ</h1>
                <p>${error.message}</p>
              </div>
            </div>
          `;
        }
      })();
    </script>
  </body>
</html>
