<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ERP - ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿπŸÑÿßÿ¨ ÿßŸÑÿ∑ÿ®ŸäÿπŸä | ERP Dashboard - Physical Therapy Center</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Custom Styles -->
  <link rel="stylesheet" href="css/custom-styles.css">

  <!-- Load Mishkah Libraries -->
  <script src="../../lib/mishkah-utils.js"></script>
  <script src="../../lib/mishkah.core.js"></script>
  <script src="../../lib/mishkah-ui.js"></script>
</head>
<body>
  <div id="app"></div>

  <script>
    (async function() {
      const M = Mishkah;
      const D = M.DSL;
      const UI = M.UI;
      const { tw, token } = M.utils.twcss;

      // Application State
      const db = {
        env: {
          lang: 'ar',
          dir: 'rtl',
          theme: 'light'
        },
        data: {
          currentPage: 'dashboard',
          showModal: false,
          modalType: null,
          formData: {},
          patients: [
            { id: 1, name: 'ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑŸÑŸá', phone: '01012345678', email: 'ahmed@example.com', age: 35, gender: 'male', status: 'active', lastVisit: '2024-01-15', totalSessions: 12, totalPaid: 3600, address: 'ÿßŸÑŸÇÿßŸáÿ±ÿ© - ŸÖÿØŸäŸÜÿ© ŸÜÿµÿ±', diagnosis: 'ÿ¢ŸÑÿßŸÖ ÿßŸÑÿ∏Ÿáÿ± ÿßŸÑŸÖÿ≤ŸÖŸÜÿ©' },
            { id: 2, name: 'ŸÅÿßÿ∑ŸÖÿ© ÿπŸÑŸä ÿ≠ÿ≥ŸÜ', phone: '01023456789', email: 'fatima@example.com', age: 28, gender: 'female', status: 'active', lastVisit: '2024-01-14', totalSessions: 8, totalPaid: 2400, address: 'ÿßŸÑÿ¨Ÿäÿ≤ÿ© - ÿßŸÑÿØŸÇŸä', diagnosis: 'ÿßŸÑÿ™Ÿáÿßÿ® ÿßŸÑŸÖŸÅÿßÿµŸÑ' },
            { id: 3, name: 'ŸÖÿ≠ŸÖŸàÿØ ÿ≥ÿßŸÑŸÖ ÿ£ÿ≠ŸÖÿØ', phone: '01034567890', email: 'mahmoud@example.com', age: 42, gender: 'male', status: 'completed', lastVisit: '2024-01-10', totalSessions: 15, totalPaid: 4500, address: 'ÿßŸÑŸÇÿßŸáÿ±ÿ© - ŸÖÿµÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©', diagnosis: 'ÿ•ÿµÿßÿ®ÿ© ÿ±Ÿäÿßÿ∂Ÿäÿ©' },
            { id: 4, name: 'ŸÜŸàÿ± ÿßŸÑÿØŸäŸÜ ÿÆÿßŸÑÿØ', phone: '01045678901', email: 'nour@example.com', age: 55, gender: 'male', status: 'active', lastVisit: '2024-01-13', totalSessions: 20, totalPaid: 6000, address: 'ÿßŸÑÿ•ÿ≥ŸÉŸÜÿØÿ±Ÿäÿ© - ÿ≥ŸÖŸàÿ≠ÿ©', diagnosis: 'ÿ¢ŸÑÿßŸÖ ÿßŸÑÿ±ŸÇÿ®ÿ©' },
            { id: 5, name: 'ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖÿØ ŸäŸàÿ≥ŸÅ', phone: '01056789012', email: 'sara@example.com', age: 31, gender: 'female', status: 'pending', lastVisit: '2024-01-09', totalSessions: 5, totalPaid: 1500, address: 'ÿßŸÑŸÇÿßŸáÿ±ÿ© - ÿßŸÑŸÖÿπÿßÿØŸä', diagnosis: 'ÿ™ÿ£ŸáŸäŸÑ ŸÖÿß ÿ®ÿπÿØ ÿßŸÑÿ¨ÿ±ÿßÿ≠ÿ©' },
            { id: 6, name: 'ÿπŸÖÿ± ÿ≠ÿ≥ŸäŸÜ ÿπŸÑŸä', phone: '01067890123', email: 'omar@example.com', age: 38, gender: 'male', status: 'active', lastVisit: '2024-01-12', totalSessions: 10, totalPaid: 3000, address: 'ÿßŸÑÿ¨Ÿäÿ≤ÿ© - ÿßŸÑŸáÿ±ŸÖ', diagnosis: 'ÿ¢ŸÑÿßŸÖ ÿßŸÑŸÉÿ™ŸÅ' },
            { id: 7, name: 'ŸÑŸäŸÑŸâ ÿ£ÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ', phone: '01078901234', email: 'layla@example.com', age: 45, gender: 'female', status: 'active', lastVisit: '2024-01-11', totalSessions: 18, totalPaid: 5400, address: 'ÿßŸÑŸÇÿßŸáÿ±ÿ© - ÿßŸÑÿ≤ŸÖÿßŸÑŸÉ', diagnosis: 'ÿπÿ±ŸÇ ÿßŸÑŸÜÿ≥ÿß' }
          ],
          appointments: [
            { id: 1, patientId: 1, patientName: 'ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑŸÑŸá', date: '2024-01-16', time: '10:00', service: 'ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿ∏Ÿáÿ±', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', status: 'confirmed', duration: 60, price: 300 },
            { id: 2, patientId: 2, patientName: 'ŸÅÿßÿ∑ŸÖÿ© ÿπŸÑŸä ÿ≠ÿ≥ŸÜ', date: '2024-01-16', time: '11:00', service: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ', therapist: 'ÿØ. ÿ£ÿ≠ŸÖÿØ ÿ≥ÿßŸÑŸÖ', status: 'pending', duration: 45, price: 250 },
            { id: 3, patientId: 3, patientName: 'ŸÖÿ≠ŸÖŸàÿØ ÿ≥ÿßŸÑŸÖ ÿ£ÿ≠ŸÖÿØ', date: '2024-01-16', time: '14:00', service: 'ÿπŸÑÿßÿ¨ ÿ±Ÿäÿßÿ∂Ÿä', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', status: 'confirmed', duration: 60, price: 300 },
            { id: 4, patientId: 4, patientName: 'ŸÜŸàÿ± ÿßŸÑÿØŸäŸÜ ÿÆÿßŸÑÿØ', date: '2024-01-16', time: '15:30', service: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿ±ŸÇÿ®ÿ©', therapist: 'ÿØ. ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖŸàÿØ', status: 'confirmed', duration: 45, price: 250 },
            { id: 5, patientId: 5, patientName: 'ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖÿØ ŸäŸàÿ≥ŸÅ', date: '2024-01-17', time: '09:00', service: 'ÿ™ÿ£ŸáŸäŸÑ ŸÖÿß ÿ®ÿπÿØ ÿßŸÑÿ¨ÿ±ÿßÿ≠ÿ©', therapist: 'ÿØ. ÿ£ÿ≠ŸÖÿØ ÿ≥ÿßŸÑŸÖ', status: 'pending', duration: 90, price: 400 },
            { id: 6, patientId: 6, patientName: 'ÿπŸÖÿ± ÿ≠ÿ≥ŸäŸÜ ÿπŸÑŸä', date: '2024-01-17', time: '11:00', service: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÉÿ™ŸÅ', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', status: 'confirmed', duration: 60, price: 300 },
            { id: 7, patientId: 7, patientName: 'ŸÑŸäŸÑŸâ ÿ£ÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ', date: '2024-01-17', time: '13:00', service: 'ÿπŸÑÿßÿ¨ ÿπÿ±ŸÇ ÿßŸÑŸÜÿ≥ÿß', therapist: 'ÿØ. ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖŸàÿØ', status: 'cancelled', duration: 60, price: 300 },
            { id: 8, patientId: 1, patientName: 'ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑŸÑŸá', date: '2024-01-18', time: '10:00', service: 'ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿ∏Ÿáÿ±', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', status: 'pending', duration: 60, price: 300 }
          ],
          sessions: [
            { id: 1, patientId: 1, patientName: 'ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑŸÑŸá', date: '2024-01-15', service: 'ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿ∏Ÿáÿ±', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', duration: 60, status: 'completed', notes: 'ÿ™ÿ≠ÿ≥ŸÜ ŸÖŸÑÿ≠Ÿàÿ∏ ŸÅŸä ŸÖÿ±ŸàŸÜÿ© ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑŸÅŸÇÿ±Ÿä', nextSession: '2024-01-18', price: 300, paid: true },
            { id: 2, patientId: 2, patientName: 'ŸÅÿßÿ∑ŸÖÿ© ÿπŸÑŸä ÿ≠ÿ≥ŸÜ', date: '2024-01-14', service: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ', therapist: 'ÿØ. ÿ£ÿ≠ŸÖÿØ ÿ≥ÿßŸÑŸÖ', duration: 45, status: 'completed', notes: 'ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿßŸÑÿ™Ÿáÿßÿ® ÿ®ÿ¥ŸÉŸÑ ÿ¨ŸäÿØ', nextSession: '2024-01-17', price: 250, paid: true },
            { id: 3, patientId: 3, patientName: 'ŸÖÿ≠ŸÖŸàÿØ ÿ≥ÿßŸÑŸÖ ÿ£ÿ≠ŸÖÿØ', date: '2024-01-13', service: 'ÿπŸÑÿßÿ¨ ÿ±Ÿäÿßÿ∂Ÿä', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', duration: 60, status: 'completed', notes: 'ÿßÿ≥ÿ™ÿπÿßÿØÿ© 80% ŸÖŸÜ ÿßŸÑŸÇŸàÿ© ÿßŸÑÿπÿ∂ŸÑŸäÿ©', nextSession: '2024-01-16', price: 300, paid: false },
            { id: 4, patientId: 4, patientName: 'ŸÜŸàÿ± ÿßŸÑÿØŸäŸÜ ÿÆÿßŸÑÿØ', date: '2024-01-13', service: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿ±ŸÇÿ®ÿ©', therapist: 'ÿØ. ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖŸàÿØ', duration: 45, status: 'completed', notes: 'ÿ™ÿ≠ÿ≥ŸÜ ŸÅŸä ŸÖÿØŸâ ÿßŸÑÿ≠ÿ±ŸÉÿ©', nextSession: '2024-01-16', price: 250, paid: true },
            { id: 5, patientId: 6, patientName: 'ÿπŸÖÿ± ÿ≠ÿ≥ŸäŸÜ ÿπŸÑŸä', date: '2024-01-12', service: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÉÿ™ŸÅ', therapist: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', duration: 60, status: 'completed', notes: 'ÿ™ŸÖÿßÿ±ŸäŸÜ ÿ™ŸÇŸàŸäÿ© ŸÜÿßÿ¨ÿ≠ÿ©', nextSession: '2024-01-17', price: 300, paid: true },
            { id: 6, patientId: 7, patientName: 'ŸÑŸäŸÑŸâ ÿ£ÿ≠ŸÖÿØ ÿ≥ÿπŸäÿØ', date: '2024-01-11', service: 'ÿπŸÑÿßÿ¨ ÿπÿ±ŸÇ ÿßŸÑŸÜÿ≥ÿß', therapist: 'ÿØ. ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖŸàÿØ', duration: 60, status: 'completed', notes: 'ÿ™ŸÇŸÑŸäŸÑ ÿßŸÑÿ£ŸÑŸÖ ÿ®ŸÜÿ≥ÿ®ÿ© 60%', nextSession: '2024-01-15', price: 300, paid: true }
          ],
          staff: [
            { id: 1, name: 'ÿØ. ŸÖÿ±Ÿàÿ© ÿ≠ÿ≥ŸäŸÜ', role: 'ÿ±ÿ¶Ÿäÿ≥ ŸÇÿ≥ŸÖ ÿßŸÑÿπŸÑÿßÿ¨ ÿßŸÑÿ∑ÿ®ŸäÿπŸä', specialization: 'ÿßŸÑÿπŸÑÿßÿ¨ ÿßŸÑÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿπŸÖŸàÿØ ÿßŸÑŸÅŸÇÿ±Ÿä', phone: '01066558085', email: 'marwa@clinic.com', joinDate: '2020-01-15', patients: 45, sessionsToday: 8 },
            { id: 2, name: 'ÿØ. ÿ£ÿ≠ŸÖÿØ ÿ≥ÿßŸÑŸÖ', role: 'ÿ£ÿÆÿµÿßÿ¶Ÿä ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä', specialization: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ ŸàÿßŸÑÿ±ŸàŸÖÿßÿ™Ÿäÿ≤ŸÖ', phone: '01123456789', email: 'ahmed@clinic.com', joinDate: '2021-03-20', patients: 32, sessionsToday: 5 },
            { id: 3, name: 'ÿØ. ÿ≥ÿßÿ±ÿ© ŸÖÿ≠ŸÖŸàÿØ', role: 'ÿ£ÿÆÿµÿßÿ¶Ÿä ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä', specialization: 'ÿßŸÑÿ•ÿµÿßÿ®ÿßÿ™ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ©', phone: '01234567890', email: 'sara@clinic.com', joinDate: '2021-09-10', patients: 28, sessionsToday: 6 },
            { id: 4, name: 'ÿ£. ŸÖÿ≠ŸÖÿØ ÿÆÿßŸÑÿØ', role: 'ŸÖÿ≥ÿßÿπÿØ ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä', specialization: 'ÿßŸÑÿ™ÿ£ŸáŸäŸÑ ÿßŸÑÿ≠ÿ±ŸÉŸä', phone: '01345678901', email: 'mohamed@clinic.com', joinDate: '2022-02-01', patients: 15, sessionsToday: 4 }
          ],
          services: [
            { id: 1, name: 'ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿ∏Ÿáÿ±', price: 300, duration: 60, category: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑŸÅŸÇÿ±Ÿä', active: true },
            { id: 2, name: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ', price: 250, duration: 45, category: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ', active: true },
            { id: 3, name: 'ÿπŸÑÿßÿ¨ ÿ±Ÿäÿßÿ∂Ÿä', price: 300, duration: 60, category: 'ÿßŸÑÿ•ÿµÿßÿ®ÿßÿ™ ÿßŸÑÿ±Ÿäÿßÿ∂Ÿäÿ©', active: true },
            { id: 4, name: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿ±ŸÇÿ®ÿ©', price: 250, duration: 45, category: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿπŸÖŸàÿØ ÿßŸÑŸÅŸÇÿ±Ÿä', active: true },
            { id: 5, name: 'ÿ™ÿ£ŸáŸäŸÑ ŸÖÿß ÿ®ÿπÿØ ÿßŸÑÿ¨ÿ±ÿßÿ≠ÿ©', price: 400, duration: 90, category: 'ÿ™ÿ£ŸáŸäŸÑ', active: true },
            { id: 6, name: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÉÿ™ŸÅ', price: 300, duration: 60, category: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ', active: true },
            { id: 7, name: 'ÿπŸÑÿßÿ¨ ÿπÿ±ŸÇ ÿßŸÑŸÜÿ≥ÿß', price: 300, duration: 60, category: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿ£ÿπÿµÿßÿ®', active: true }
          ],
          payments: [
            { id: 1, patientId: 1, patientName: 'ÿ£ÿ≠ŸÖÿØ ŸÖÿ≠ŸÖÿØ ÿπÿ®ÿØÿßŸÑŸÑŸá', date: '2024-01-15', amount: 300, service: 'ÿπŸÑÿßÿ¨ ÿ∑ÿ®ŸäÿπŸä ŸÑŸÑÿ∏Ÿáÿ±', method: 'ŸÜŸÇÿØŸä', status: 'completed', invoiceNo: 'INV-001' },
            { id: 2, patientId: 2, patientName: 'ŸÅÿßÿ∑ŸÖÿ© ÿπŸÑŸä ÿ≠ÿ≥ŸÜ', date: '2024-01-14', amount: 250, service: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÖŸÅÿßÿµŸÑ', method: 'ÿ®ÿ∑ÿßŸÇÿ© ÿßÿ¶ÿ™ŸÖÿßŸÜ', status: 'completed', invoiceNo: 'INV-002' },
            { id: 3, patientId: 3, patientName: 'ŸÖÿ≠ŸÖŸàÿØ ÿ≥ÿßŸÑŸÖ ÿ£ÿ≠ŸÖÿØ', date: '2024-01-13', amount: 300, service: 'ÿπŸÑÿßÿ¨ ÿ±Ÿäÿßÿ∂Ÿä', method: 'ŸÜŸÇÿØŸä', status: 'pending', invoiceNo: 'INV-003' },
            { id: 4, patientId: 4, patientName: 'ŸÜŸàÿ± ÿßŸÑÿØŸäŸÜ ÿÆÿßŸÑÿØ', date: '2024-01-13', amount: 250, service: 'ÿπŸÑÿßÿ¨ ÿßŸÑÿ±ŸÇÿ®ÿ©', method: 'ÿ™ÿ≠ŸàŸäŸÑ ÿ®ŸÜŸÉŸä', status: 'completed', invoiceNo: 'INV-004' },
            { id: 5, patientId: 6, patientName: 'ÿπŸÖÿ± ÿ≠ÿ≥ŸäŸÜ ÿπŸÑŸä', date: '2024-01-12', amount: 300, service: 'ÿπŸÑÿßÿ¨ ÿßŸÑŸÉÿ™ŸÅ', method: 'ŸÜŸÇÿØŸä', status: 'completed', invoiceNo: 'INV-005' }
          ],
          stats: {
            totalPatients: 145,
            todayAppointments: 12,
            completedSessions: 1250,
            revenue: 125000,
            monthlyRevenue: 45000,
            pendingPayments: 3500,
            activeStaff: 4,
            todaySessions: 23
          }
        },
        i18n: {
          dict: {
            'dashboard': { ar: 'ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ', en: 'Dashboard' },
            'patients': { ar: 'ÿßŸÑŸÖÿ±ÿ∂Ÿâ', en: 'Patients' },
            'appointments': { ar: 'ÿßŸÑŸÖŸàÿßÿπŸäÿØ', en: 'Appointments' },
            'sessions': { ar: 'ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™', en: 'Sessions' },
            'reports': { ar: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ±', en: 'Reports' },
            'settings': { ar: 'ÿßŸÑÿ•ÿπÿØÿßÿØÿßÿ™', en: 'Settings' },
            'totalPatients': { ar: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿ±ÿ∂Ÿâ', en: 'Total Patients' },
            'todayAppointments': { ar: 'ŸÖŸàÿßÿπŸäÿØ ÿßŸÑŸäŸàŸÖ', en: "Today's Appointments" },
            'completedSessions': { ar: 'ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸÖŸÉÿ™ŸÖŸÑÿ©', en: 'Completed Sessions' },
            'revenue': { ar: 'ÿßŸÑÿ•Ÿäÿ±ÿßÿØÿßÿ™', en: 'Revenue' },
            'recentPatients': { ar: 'ÿßŸÑŸÖÿ±ÿ∂Ÿâ ÿßŸÑÿ£ÿÆŸäÿ±ŸàŸÜ', en: 'Recent Patients' },
            'upcomingAppointments': { ar: 'ÿßŸÑŸÖŸàÿßÿπŸäÿØ ÿßŸÑŸÇÿßÿØŸÖÿ©', en: 'Upcoming Appointments' },
            'addNew': { ar: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ÿØŸäÿØ', en: 'Add New' },
            'name': { ar: 'ÿßŸÑÿßÿ≥ŸÖ', en: 'Name' },
            'phone': { ar: 'ÿßŸÑŸáÿßÿ™ŸÅ', en: 'Phone' },
            'email': { ar: 'ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä', en: 'Email' },
            'age': { ar: 'ÿßŸÑÿπŸÖÿ±', en: 'Age' },
            'gender': { ar: 'ÿßŸÑŸÜŸàÿπ', en: 'Gender' },
            'male': { ar: 'ÿ∞ŸÉÿ±', en: 'Male' },
            'female': { ar: 'ÿ£ŸÜÿ´Ÿâ', en: 'Female' },
            'address': { ar: 'ÿßŸÑÿπŸÜŸàÿßŸÜ', en: 'Address' },
            'diagnosis': { ar: 'ÿßŸÑÿ™ÿ¥ÿÆŸäÿµ', en: 'Diagnosis' },
            'status': { ar: 'ÿßŸÑÿ≠ÿßŸÑÿ©', en: 'Status' },
            'lastVisit': { ar: 'ÿ¢ÿÆÿ± ÿ≤Ÿäÿßÿ±ÿ©', en: 'Last Visit' },
            'sessions': { ar: 'ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™', en: 'Sessions' },
            'totalPaid': { ar: 'ÿ•ÿ¨ŸÖÿßŸÑŸä ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™', en: 'Total Paid' },
            'patient': { ar: 'ÿßŸÑŸÖÿ±Ÿäÿ∂', en: 'Patient' },
            'date': { ar: 'ÿßŸÑÿ™ÿßÿ±ŸäÿÆ', en: 'Date' },
            'time': { ar: 'ÿßŸÑŸàŸÇÿ™', en: 'Time' },
            'service': { ar: 'ÿßŸÑÿÆÿØŸÖÿ©', en: 'Service' },
            'therapist': { ar: 'ÿßŸÑŸÖÿπÿßŸÑÿ¨', en: 'Therapist' },
            'duration': { ar: 'ÿßŸÑŸÖÿØÿ©', en: 'Duration' },
            'price': { ar: 'ÿßŸÑÿ≥ÿπÿ±', en: 'Price' },
            'notes': { ar: 'ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™', en: 'Notes' },
            'nextSession': { ar: 'ÿßŸÑÿ¨ŸÑÿ≥ÿ© ÿßŸÑŸÇÿßÿØŸÖÿ©', en: 'Next Session' },
            'paid': { ar: 'ŸÖÿØŸÅŸàÿπ', en: 'Paid' },
            'unpaid': { ar: 'ÿ∫Ÿäÿ± ŸÖÿØŸÅŸàÿπ', en: 'Unpaid' },
            'active': { ar: 'ŸÜÿ¥ÿ∑', en: 'Active' },
            'completed': { ar: 'ŸÖŸÉÿ™ŸÖŸÑ', en: 'Completed' },
            'confirmed': { ar: 'ŸÖÿ§ŸÉÿØ', en: 'Confirmed' },
            'pending': { ar: 'ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±', en: 'Pending' },
            'cancelled': { ar: 'ŸÖŸÑÿ∫Ÿâ', en: 'Cancelled' },
            'allPatients': { ar: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', en: 'All Patients' },
            'allAppointments': { ar: 'ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸàÿßÿπŸäÿØ', en: 'All Appointments' },
            'sessionHistory': { ar: 'ÿ≥ÿ¨ŸÑ ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™', en: 'Session History' },
            'recentSessions': { ar: 'ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©', en: 'Recent Sessions' },
            'staff': { ar: 'ŸÅÿ±ŸäŸÇ ÿßŸÑÿπŸÖŸÑ', en: 'Staff' },
            'role': { ar: 'ÿßŸÑŸàÿ∏ŸäŸÅÿ©', en: 'Role' },
            'specialization': { ar: 'ÿßŸÑÿ™ÿÆÿµÿµ', en: 'Specialization' },
            'joinDate': { ar: 'ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ∂ŸÖÿßŸÖ', en: 'Join Date' },
            'patientsCount': { ar: 'ÿπÿØÿØ ÿßŸÑŸÖÿ±ÿ∂Ÿâ', en: 'Patients' },
            'sessionsToday': { ar: 'ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸäŸàŸÖ', en: "Today's Sessions" },
            'serviceName': { ar: 'ÿßÿ≥ŸÖ ÿßŸÑÿÆÿØŸÖÿ©', en: 'Service Name' },
            'category': { ar: 'ÿßŸÑŸÅÿ¶ÿ©', en: 'Category' },
            'amount': { ar: 'ÿßŸÑŸÖÿ®ŸÑÿ∫', en: 'Amount' },
            'method': { ar: 'ÿ∑ÿ±ŸäŸÇÿ© ÿßŸÑÿØŸÅÿπ', en: 'Payment Method' },
            'invoiceNo': { ar: 'ÿ±ŸÇŸÖ ÿßŸÑŸÅÿßÿ™Ÿàÿ±ÿ©', en: 'Invoice No' },
            'monthlyRevenue': { ar: 'ÿ•Ÿäÿ±ÿßÿØÿßÿ™ ÿßŸÑÿ¥Ÿáÿ±', en: 'Monthly Revenue' },
            'pendingPayments': { ar: 'ŸÖÿØŸÅŸàÿπÿßÿ™ ŸÖÿπŸÑŸÇÿ©', en: 'Pending Payments' },
            'activeStaff': { ar: 'ŸÅÿ±ŸäŸÇ ÿßŸÑÿπŸÖŸÑ ÿßŸÑŸÜÿ¥ÿ∑', en: 'Active Staff' },
            'todaySessions': { ar: 'ÿ¨ŸÑÿ≥ÿßÿ™ ÿßŸÑŸäŸàŸÖ', en: "Today's Sessions" },
            'financialReports': { ar: 'ÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿßŸÑŸäÿ©', en: 'Financial Reports' },
            'patientReports': { ar: 'ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑŸÖÿ±ÿ∂Ÿâ', en: 'Patient Reports' },
            'sessionReports': { ar: 'ÿ™ŸÇÿßÿ±Ÿäÿ± ÿßŸÑÿ¨ŸÑÿ≥ÿßÿ™', en: 'Session Reports' },
            'payments': { ar: 'ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™', en: 'Payments' },
            'recentPayments': { ar: 'ÿßŸÑŸÖÿØŸÅŸàÿπÿßÿ™ ÿßŸÑÿ£ÿÆŸäÿ±ÿ©', en: 'Recent Payments' },
            'clinicSettings': { ar: 'ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑÿπŸäÿßÿØÿ©', en: 'Clinic Settings' },
            'services': { ar: 'ÿßŸÑÿÆÿØŸÖÿßÿ™', en: 'Services' },
            'actions': { ar: 'ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™', en: 'Actions' }
          }
        }
      };

      // Translation Helper
      const t = function(key) {
        const lang = db.env.lang || 'ar';
        const dict = db.i18n.dict || {};
        return dict[key] && dict[key][lang] ? dict[key][lang] : key;
      };

      // Event Handlers
      const orders = {
        'nav:click': {
          on: ['click'],
          gkeys: ['nav:click'],
          handler: function(event, context) {
            // Use closest() to find the element with data-page, even if user clicked on child span
            const target = event.target.closest('[data-page]');
            if (!target) return; // Exit if no data-page found

            const page = target.dataset.page;
            const state = context.getState();
            state.data.currentPage = page;
            context.rebuild();
          }
        },

        'lang:switch': {
          on: ['click'],
          gkeys: ['lang:switch'],
          handler: function(event, context) {
            const target = event.target.closest('[data-lang]');
            if (!target) return;

            const newLang = target.dataset.lang;
            const state = context.getState();
            state.env.lang = newLang;
            state.env.dir = newLang === 'ar' ? 'rtl' : 'ltr';
            document.documentElement.setAttribute('lang', newLang);
            document.documentElement.setAttribute('dir', state.env.dir);
            context.rebuild();
          }
        },

        'theme:toggle': {
          on: ['click'],
          gkeys: ['theme:toggle'],
          handler: function(event, context) {
            const state = context.getState();
            state.env.theme = state.env.theme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', state.env.theme);
            context.rebuild();
          }
        },

        'modal:open': {
          on: ['click'],
          gkeys: ['modal:open'],
          handler: function(event, context) {
            const target = event.target.closest('[data-modal-type]');
            if (!target) return;

            const modalType = target.dataset.modalType;
            const state = context.getState();
            state.data.showModal = true;
            state.data.modalType = modalType;
            context.rebuild();
          }
        },

        'modal:close': {
          on: ['click'],
          gkeys: ['modal:close'],
          handler: function(event, context) {
            const state = context.getState();
            state.data.showModal = false;
            state.data.modalType = null;
            state.data.formData = {};
            context.rebuild();
          }
        },

        'modal:overlay-click': {
          on: ['click'],
          gkeys: ['modal:overlay-click'],
          handler: function(event, context) {
            if (event.target.dataset.mGkey === 'modal:overlay-click') {
              const state = context.getState();
              state.data.showModal = false;
              state.data.modalType = null;
              state.data.formData = {};
              context.rebuild();
            }
          }
        },

        'form:input': {
          on: ['input', 'change'],
          gkeys: ['form:input'],
          handler: function(event, context) {
            const field = event.target.name;
            const value = event.target.value;
            const state = context.getState();
            if (!state.data.formData) state.data.formData = {};
            state.data.formData[field] = value;
          }
        },

        'form:submit': {
          on: ['submit'],
          gkeys: ['form:submit'],
          handler: function(event, context) {
            event.preventDefault();
            const state = context.getState();
            const modalType = state.data.modalType;
            const formData = state.data.formData || {};

            // Simple validation
            if (!formData.name && !formData.patientName) {
              alert(state.env.lang === 'ar' ? 'ÿßŸÑÿ±ÿ¨ÿßÿ° ÿ•ÿØÿÆÿßŸÑ ÿßŸÑÿßÿ≥ŸÖ' : 'Please enter name');
              return;
            }

            // Generate new ID
            const newId = Date.now();

            // Add to appropriate array
            if (modalType === 'patient') {
              state.data.patients.push({
                id: newId,
                name: formData.name || '',
                phone: formData.phone || '',
                email: formData.email || '',
                age: parseInt(formData.age) || 0,
                gender: formData.gender || 'male',
                status: 'active',
                lastVisit: new Date().toISOString().split('T')[0],
                totalSessions: 0,
                totalPaid: 0,
                address: formData.address || '',
                diagnosis: formData.diagnosis || ''
              });
            } else if (modalType === 'appointment') {
              state.data.appointments.push({
                id: newId,
                patientId: parseInt(formData.patientId) || 0,
                patientName: formData.patientName || '',
                date: formData.date || '',
                time: formData.time || '',
                service: formData.service || '',
                therapist: formData.therapist || '',
                status: 'pending',
                duration: parseInt(formData.duration) || 60,
                price: parseInt(formData.price) || 300
              });
            } else if (modalType === 'session') {
              state.data.sessions.push({
                id: newId,
                patientId: parseInt(formData.patientId) || 0,
                patientName: formData.patientName || '',
                date: formData.date || '',
                service: formData.service || '',
                therapist: formData.therapist || '',
                duration: parseInt(formData.duration) || 60,
                status: 'completed',
                notes: formData.notes || '',
                nextSession: formData.nextSession || '',
                price: parseInt(formData.price) || 300,
                paid: formData.paid === 'true'
              });
            } else if (modalType === 'staff') {
              state.data.staff.push({
                id: newId,
                name: formData.name || '',
                role: formData.role || '',
                specialization: formData.specialization || '',
                phone: formData.phone || '',
                email: formData.email || '',
                joinDate: formData.joinDate || new Date().toISOString().split('T')[0],
                patients: 0,
                sessionsToday: 0
              });
            } else if (modalType === 'service') {
              state.data.services.push({
                id: newId,
                name: formData.name || '',
                price: parseInt(formData.price) || 0,
                duration: parseInt(formData.duration) || 60,
                category: formData.category || '',
                active: true
              });
            }

            // Close modal
            state.data.showModal = false;
            state.data.modalType = null;
            state.data.formData = {};
            context.rebuild();

            // Show success message
            alert(state.env.lang === 'ar' ? 'ÿ™ŸÖ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸÜÿ¨ÿßÿ≠!' : 'Added successfully!');
          }
        }
      };

      // Components
      function Sidebar(db, D) {
        const menuItems = [
          { icon: 'üìä', page: 'dashboard', label: t('dashboard') },
          { icon: 'üë•', page: 'patients', label: t('patients') },
          { icon: 'üìÖ', page: 'appointments', label: t('appointments') },
          { icon: 'üíÜ', page: 'sessions', label: t('sessions') },
          { icon: 'üìà', page: 'reports', label: t('reports') },
          { icon: '‚öôÔ∏è', page: 'settings', label: t('settings') }
        ];

        return D.Containers.Aside({
          attrs: { class: tw`w-64 bg-[var(--card)] border-e border-[var(--border)] p-6 fixed h-screen overflow-y-auto ${token('surface')}` }
        }, [
          // Header
          D.Containers.Div({ attrs: { class: tw`mb-8 pb-4 border-b border-[var(--border)]` } }, [
            D.Text.H2({ attrs: { class: tw`text-lg font-bold text-[var(--primary)]` } }, [
              'üè• ' + (db.env.lang === 'ar' ? 'ŸÖÿ±ŸÉÿ≤ ÿßŸÑÿπŸÑÿßÿ¨ ÿßŸÑÿ∑ÿ®ŸäÿπŸä' : 'Physical Therapy Center')
            ])
          ]),

          // Menu
          D.Lists.Ul({ attrs: { class: tw`${token('vstack')} gap-2` } },
            menuItems.map(item =>
              D.Lists.Li({ attrs: { key: item.page } }, [
                D.Text.A({
                  attrs: {
                    class: tw`flex items-center gap-3 px-4 py-3 rounded-lg transition-all duration-200 cursor-pointer ${
                      db.data.currentPage === item.page
                        ? 'bg-[var(--primary)] text-[var(--primary-foreground)] shadow-md'
                        : 'hover:bg-[var(--accent)] text-[var(--foreground)]'
                    }`,
                    'data-m-gkey': 'nav:click',
                    'data-page': item.page
                  }
                }, [
                  D.Text.Span({ attrs: { class: tw`text-xl` } }, [item.icon]),
                  D.Text.Span({ attrs: { class: tw`font-medium` } }, [item.label])
                ])
              ])
            )
          )
        ]);
      }

      function Header(db, D) {
        return D.Containers.Div({ attrs: { class: tw`${token('split')} mb-8 pb-4 border-b border-[var(--border)]` } }, [
          D.Text.H1({ attrs: { class: tw`text-3xl font-bold text-[var(--foreground)]` } }, [t(db.data.currentPage)]),
          D.Containers.Div({ attrs: { class: tw`${token('hstack')} gap-3` } }, [
            UI.Switcher({
              attrs: { 'data-m-gkey': 'lang:switch' },
              value: db.env.lang,
              options: [
                { label: 'ÿπ', value: 'ar', attrs: { 'data-lang': 'ar' } },
                { label: 'EN', value: 'en', attrs: { 'data-lang': 'en' } }
              ]
            }),
            UI.Button({
              attrs: {
                'data-m-gkey': 'theme:toggle',
                title: db.env.theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode'
              },
              variant: 'ghost',
              size: 'md'
            }, [db.env.theme === 'dark' ? 'üåû' : 'üåô'])
          ])
        ]);
      }

      function StatCard({ icon, title, value, change, changeType }, D) {
        const changeColors = {
          positive: 'text-green-600 dark:text-green-400',
          neutral: 'text-blue-600 dark:text-blue-400',
          negative: 'text-red-600 dark:text-red-400'
        };

        return D.Containers.Div({ attrs: { class: tw`${token('card')} p-6 hover:shadow-lg transition-shadow duration-200` } }, [
          D.Containers.Div({ attrs: { class: tw`${token('split')} mb-4` } }, [
            D.Text.Span({ attrs: { class: tw`text-sm font-medium ${token('muted')}` } }, [title]),
            D.Text.Span({ attrs: { class: tw`text-2xl` } }, [icon])
          ]),
          D.Containers.Div({ attrs: { class: tw`text-3xl font-bold text-[var(--foreground)] mb-2` } }, [value]),
          D.Containers.Div({ attrs: { class: tw`text-sm ${changeColors[changeType || 'neutral']}` } }, [change])
        ]);
      }

      function StatsGrid(db, D) {
        return D.Containers.Div({ attrs: { class: tw`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8` } }, [
          StatCard({
            icon: 'üë•',
            title: t('totalPatients'),
            value: String(db.data.stats.totalPatients),
            change: '‚Üë 12% ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿßÿ∂Ÿä',
            changeType: 'positive'
          }, D),
          StatCard({
            icon: 'üìÖ',
            title: t('todayAppointments'),
            value: String(db.data.stats.todayAppointments),
            change: '5 ŸÖÿ§ŸÉÿØÿå 7 ŸÇŸäÿØ ÿßŸÑÿßŸÜÿ™ÿ∏ÿßÿ±',
            changeType: 'neutral'
          }, D),
          StatCard({
            icon: '‚úÖ',
            title: t('completedSessions'),
            value: String(db.data.stats.completedSessions),
            change: '‚Üë 8% ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿßÿ∂Ÿä',
            changeType: 'positive'
          }, D),
          StatCard({
            icon: 'üí∞',
            title: t('revenue'),
            value: String(db.data.stats.revenue) + ' ÿ¨.ŸÖ',
            change: '‚Üë 15% ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿßÿ∂Ÿä',
            changeType: 'positive'
          }, D)
        ]);
      }

      function DataTable({ title, headers, rows, onAdd }, D) {
        return D.Containers.Div({ attrs: { class: tw`${token('card')} mb-6` } }, [
          // Header
          D.Containers.Div({ attrs: { class: tw`${token('card/header')}` } }, [
            D.Text.H2({ attrs: { class: tw`${token('card/title')}` } }, [title]),
            onAdd ? UI.Button({
              attrs: {
                'data-m-gkey': 'modal:open',
                'data-modal-type': onAdd.type
              },
              variant: 'solid',
              size: 'sm'
            }, ['+ ' + t('addNew')]) : null
          ]),

          // Table
          D.Containers.Div({ attrs: { class: tw`${token('card/content')} overflow-x-auto` } }, [
            D.Containers.Div({ attrs: { class: tw`min-w-full` } }, [
              // Table Header
              D.Containers.Div({ attrs: { class: tw`bg-[var(--surface-1)] border-b-2 border-[var(--border)]` } }, [
                D.Containers.Div({ attrs: { class: tw`grid gap-4 p-4` + ` grid-cols-${headers.length}` } },
                  headers.map(header =>
                    D.Containers.Div({ attrs: { class: tw`text-sm font-semibold text-[var(--foreground)]` } }, [header])
                  )
                )
              ]),

              // Table Body
              D.Containers.Div({},
                rows.map((row, idx) =>
                  D.Containers.Div({
                    attrs: {
                      key: idx,
                      class: tw`border-b border-[var(--border)] hover:bg-[var(--accent)] transition-colors duration-150`
                    }
                  }, [
                    D.Containers.Div({ attrs: { class: tw`grid gap-4 p-4` + ` grid-cols-${headers.length}` } }, row)
                  ])
                )
              )
            ])
          ])
        ]);
      }

      function Badge({ text, variant }, D) {
        const variants = {
          success: 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200',
          warning: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200',
          danger: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200',
          info: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200'
        };

        return D.Text.Span({
          attrs: {
            class: tw`${token('badge')} ${variants[variant] || variants.info}`
          }
        }, [text]);
      }

      function DashboardPage(db, D) {
        // Patients table
        const patientsHeaders = [t('name'), t('phone'), t('status'), t('lastVisit'), t('sessions')];
        const patientsRows = db.data.patients.map(patient => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [patient.name]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [patient.phone]),
          Badge({
            text: t(patient.status),
            variant: patient.status === 'active' ? 'success' : 'info'
          }, D),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [patient.lastVisit]),
          D.Text.Span({ attrs: { class: tw`font-semibold text-[var(--primary)]` } }, [String(patient.totalSessions)])
        ]);

        // Appointments table
        const appointmentsHeaders = [t('patient'), t('date'), t('time'), t('service'), t('status')];
        const appointmentsRows = db.data.appointments.map(appointment => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [appointment.patientName]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [appointment.date]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [appointment.time]),
          D.Text.Span({ attrs: { class: tw`text-[var(--foreground)]` } }, [appointment.service]),
          Badge({
            text: t(appointment.status),
            variant: appointment.status === 'confirmed' ? 'success' : 'warning'
          }, D)
        ]);

        return D.Containers.Div({}, [
          StatsGrid(db, D),
          DataTable({
            title: t('recentPatients'),
            headers: patientsHeaders,
            rows: patientsRows,
            onAdd: { type: 'patient' }
          }, D),
          DataTable({
            title: t('upcomingAppointments'),
            headers: appointmentsHeaders,
            rows: appointmentsRows,
            onAdd: { type: 'appointment' }
          }, D)
        ]);
      }

      function PatientsPage(db, D) {
        const headers = [t('name'), t('phone'), t('email'), t('age'), t('diagnosis'), t('status'), t('lastVisit'), t('totalPaid')];
        const rows = db.data.patients.map(patient => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [patient.name]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [patient.phone]),
          D.Text.Span({ attrs: { class: tw`${token('muted')} text-xs` } }, [patient.email]),
          D.Text.Span({ attrs: { class: tw`text-center` } }, [String(patient.age)]),
          D.Text.Span({ attrs: { class: tw`text-sm` } }, [patient.diagnosis]),
          Badge({
            text: t(patient.status),
            variant: patient.status === 'active' ? 'success' : patient.status === 'completed' ? 'info' : 'warning'
          }, D),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [patient.lastVisit]),
          D.Text.Span({ attrs: { class: tw`font-semibold text-[var(--primary)]` } }, [String(patient.totalPaid) + ' ÿ¨.ŸÖ'])
        ]);

        return D.Containers.Div({}, [
          DataTable({
            title: t('allPatients'),
            headers: headers,
            rows: rows,
            onAdd: { type: 'patient' }
          }, D)
        ]);
      }

      function AppointmentsPage(db, D) {
        const headers = [t('patient'), t('date'), t('time'), t('service'), t('therapist'), t('duration'), t('price'), t('status')];
        const rows = db.data.appointments.map(appointment => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [appointment.patientName]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [appointment.date]),
          D.Text.Span({ attrs: { class: tw`font-semibold text-[var(--primary)]` } }, [appointment.time]),
          D.Text.Span({ attrs: { class: tw`text-sm` } }, [appointment.service]),
          D.Text.Span({ attrs: { class: tw`text-sm ${token('muted')}` } }, [appointment.therapist]),
          D.Text.Span({ attrs: { class: tw`text-center` } }, [String(appointment.duration) + ' ÿØŸÇŸäŸÇÿ©']),
          D.Text.Span({ attrs: { class: tw`font-semibold` } }, [String(appointment.price) + ' ÿ¨.ŸÖ']),
          Badge({
            text: t(appointment.status),
            variant: appointment.status === 'confirmed' ? 'success' : appointment.status === 'cancelled' ? 'danger' : 'warning'
          }, D)
        ]);

        return D.Containers.Div({}, [
          DataTable({
            title: t('allAppointments'),
            headers: headers,
            rows: rows,
            onAdd: { type: 'appointment' }
          }, D)
        ]);
      }

      function SessionsPage(db, D) {
        const headers = [t('patient'), t('date'), t('service'), t('therapist'), t('duration'), t('notes'), t('nextSession'), t('price'), t('paid')];
        const rows = db.data.sessions.map(session => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [session.patientName]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [session.date]),
          D.Text.Span({ attrs: { class: tw`text-sm` } }, [session.service]),
          D.Text.Span({ attrs: { class: tw`text-sm ${token('muted')}` } }, [session.therapist]),
          D.Text.Span({ attrs: { class: tw`text-center` } }, [String(session.duration) + ' ÿØŸÇŸäŸÇÿ©']),
          D.Text.Span({ attrs: { class: tw`text-xs max-w-[200px] truncate` } }, [session.notes]),
          D.Text.Span({ attrs: { class: tw`${token('muted')} text-sm` } }, [session.nextSession]),
          D.Text.Span({ attrs: { class: tw`font-semibold` } }, [String(session.price) + ' ÿ¨.ŸÖ']),
          Badge({
            text: session.paid ? t('paid') : t('unpaid'),
            variant: session.paid ? 'success' : 'warning'
          }, D)
        ]);

        return D.Containers.Div({}, [
          DataTable({
            title: t('sessionHistory'),
            headers: headers,
            rows: rows,
            onAdd: { type: 'session' }
          }, D)
        ]);
      }

      function ReportsPage(db, D) {
        // Financial Stats Grid
        const financialStats = D.Containers.Div({ attrs: { class: tw`grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8` } }, [
          StatCard({
            icon: 'üí∞',
            title: t('revenue'),
            value: String(db.data.stats.revenue) + ' ÿ¨.ŸÖ',
            change: '‚Üë 15% ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿßÿ∂Ÿä',
            changeType: 'positive'
          }, D),
          StatCard({
            icon: 'üìä',
            title: t('monthlyRevenue'),
            value: String(db.data.stats.monthlyRevenue) + ' ÿ¨.ŸÖ',
            change: 'Ÿáÿ∞ÿß ÿßŸÑÿ¥Ÿáÿ±',
            changeType: 'neutral'
          }, D),
          StatCard({
            icon: '‚è≥',
            title: t('pendingPayments'),
            value: String(db.data.stats.pendingPayments) + ' ÿ¨.ŸÖ',
            change: '3 ŸÖÿØŸÅŸàÿπÿßÿ™ ŸÖÿπŸÑŸÇÿ©',
            changeType: 'warning'
          }, D),
          StatCard({
            icon: '‚úÖ',
            title: t('completedSessions'),
            value: String(db.data.stats.completedSessions),
            change: '‚Üë 8% ŸÖŸÜ ÿßŸÑÿ¥Ÿáÿ± ÿßŸÑŸÖÿßÿ∂Ÿä',
            changeType: 'positive'
          }, D)
        ]);

        // Recent Payments Table
        const paymentsHeaders = [t('invoiceNo'), t('patient'), t('date'), t('service'), t('amount'), t('method'), t('status')];
        const paymentsRows = db.data.payments.map(payment => [
          D.Text.Span({ attrs: { class: tw`font-mono text-sm font-semibold text-[var(--primary)]` } }, [payment.invoiceNo]),
          D.Text.Span({ attrs: { class: tw`font-medium` } }, [payment.patientName]),
          D.Text.Span({ attrs: { class: tw`${token('muted')}` } }, [payment.date]),
          D.Text.Span({ attrs: { class: tw`text-sm` } }, [payment.service]),
          D.Text.Span({ attrs: { class: tw`font-semibold text-green-600` } }, [String(payment.amount) + ' ÿ¨.ŸÖ']),
          D.Text.Span({ attrs: { class: tw`text-sm ${token('muted')}` } }, [payment.method]),
          Badge({
            text: t(payment.status),
            variant: payment.status === 'completed' ? 'success' : 'warning'
          }, D)
        ]);

        return D.Containers.Div({}, [
          financialStats,
          DataTable({
            title: t('recentPayments'),
            headers: paymentsHeaders,
            rows: paymentsRows
          }, D)
        ]);
      }

      function SettingsPage(db, D) {
        // Staff Table
        const staffHeaders = [t('name'), t('role'), t('specialization'), t('phone'), t('email'), t('joinDate'), t('patientsCount'), t('sessionsToday')];
        const staffRows = db.data.staff.map(staff => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [staff.name]),
          D.Text.Span({ attrs: { class: tw`text-sm ${token('muted')}` } }, [staff.role]),
          D.Text.Span({ attrs: { class: tw`text-sm` } }, [staff.specialization]),
          D.Text.Span({ attrs: { class: tw`${token('muted')} text-sm` } }, [staff.phone]),
          D.Text.Span({ attrs: { class: tw`${token('muted')} text-xs` } }, [staff.email]),
          D.Text.Span({ attrs: { class: tw`${token('muted')} text-sm` } }, [staff.joinDate]),
          D.Text.Span({ attrs: { class: tw`text-center font-semibold text-[var(--primary)]` } }, [String(staff.patients)]),
          D.Text.Span({ attrs: { class: tw`text-center font-semibold` } }, [String(staff.sessionsToday)])
        ]);

        // Services Table
        const servicesHeaders = [t('serviceName'), t('category'), t('duration'), t('price'), t('status')];
        const servicesRows = db.data.services.map(service => [
          D.Text.Span({ attrs: { class: tw`font-medium text-[var(--foreground)]` } }, [service.name]),
          D.Text.Span({ attrs: { class: tw`text-sm ${token('muted')}` } }, [service.category]),
          D.Text.Span({ attrs: { class: tw`text-center` } }, [String(service.duration) + ' ÿØŸÇŸäŸÇÿ©']),
          D.Text.Span({ attrs: { class: tw`font-semibold text-[var(--primary)]` } }, [String(service.price) + ' ÿ¨.ŸÖ']),
          Badge({
            text: service.active ? t('active') : 'ÿ∫Ÿäÿ± ŸÜÿ¥ÿ∑',
            variant: service.active ? 'success' : 'danger'
          }, D)
        ]);

        return D.Containers.Div({}, [
          DataTable({
            title: t('staff'),
            headers: staffHeaders,
            rows: staffRows,
            onAdd: { type: 'staff' }
          }, D),
          DataTable({
            title: t('services'),
            headers: servicesHeaders,
            rows: servicesRows,
            onAdd: { type: 'service' }
          }, D)
        ]);
      }

      function MainContent(db, D) {
        let pageContent;

        switch(db.data.currentPage) {
          case 'dashboard':
            pageContent = DashboardPage(db, D);
            break;
          case 'patients':
            pageContent = PatientsPage(db, D);
            break;
          case 'appointments':
            pageContent = AppointmentsPage(db, D);
            break;
          case 'sessions':
            pageContent = SessionsPage(db, D);
            break;
          case 'reports':
            pageContent = ReportsPage(db, D);
            break;
          case 'settings':
            pageContent = SettingsPage(db, D);
            break;
          default:
            pageContent = DashboardPage(db, D);
        }

        return D.Containers.Main({ attrs: { class: tw`flex-1 ms-64 p-8 min-h-screen ${token('surface')}` } }, [
          Header(db, D),
          pageContent
        ]);
      }

      // Modal Form Component
      function ModalForm(db, D) {
        if (!db.data.showModal) return null;

        const modalType = db.data.modalType;
        const formData = db.data.formData || {};

        // Modal titles
        const titles = {
          patient: { ar: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ±Ÿäÿ∂ ÿ¨ÿØŸäÿØ', en: 'Add New Patient' },
          appointment: { ar: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿπÿØ ÿ¨ÿØŸäÿØ', en: 'Add New Appointment' },
          session: { ar: 'ÿ•ÿ∂ÿßŸÅÿ© ÿ¨ŸÑÿ≥ÿ© ÿ¨ÿØŸäÿØÿ©', en: 'Add New Session' },
          staff: { ar: 'ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸàÿ∏ŸÅ ÿ¨ÿØŸäÿØ', en: 'Add New Staff' },
          service: { ar: 'ÿ•ÿ∂ÿßŸÅÿ© ÿÆÿØŸÖÿ© ÿ¨ÿØŸäÿØÿ©', en: 'Add New Service' }
        };

        const title = titles[modalType] ? titles[modalType][db.env.lang] : 'Add New';

        return D.Containers.Div({
          attrs: {
            class: 'modal-overlay',
            'data-m-gkey': 'modal:overlay-click'
          }
        }, [
          D.Containers.Div({
            attrs: {
              class: 'modal-content modal-form-card'
            }
          }, [
            // Close Button
            D.Forms.Button({
              attrs: {
                type: 'button',
                class: 'modal-close-btn',
                'data-m-gkey': 'modal:close',
                'aria-label': 'Close'
              }
            }, ['√ó']),

            // Title
            D.Text.H2({ attrs: { class: 'modal-title' } }, [title]),

            // Form
            D.Forms.Form({ attrs: { class: 'modal-form', 'data-m-gkey': 'form:submit' } }, [
              modalType === 'patient' ? PatientForm(formData, D) :
              modalType === 'appointment' ? AppointmentForm(formData, db, D) :
              modalType === 'session' ? SessionForm(formData, db, D) :
              modalType === 'staff' ? StaffForm(formData, D) :
              modalType === 'service' ? ServiceForm(formData, D) :
              null,

              // Form Actions
              D.Containers.Div({ attrs: { class: 'form-actions' } }, [
                D.Forms.Button({
                  attrs: {
                    type: 'button',
                    class: 'btn btn-secondary',
                    'data-m-gkey': 'modal:close'
                  }
                }, [t('booking.cancel')]),
                D.Forms.Button({
                  attrs: {
                    type: 'submit',
                    class: 'btn btn-primary'
                  }
                }, [db.env.lang === 'ar' ? 'ÿ≠ŸÅÿ∏' : 'Save'])
              ])
            ])
          ])
        ]);
      }

      // Form Components
      function PatientForm(formData, D) {
        return D.Containers.Div({ attrs: { class: 'form-grid' } }, [
          FormField({ label: t('name') + ' *', name: 'name', type: 'text', value: formData.name, required: true }, D),
          FormField({ label: t('phone') + ' *', name: 'phone', type: 'tel', value: formData.phone, required: true }, D),
          FormField({ label: t('email'), name: 'email', type: 'email', value: formData.email }, D),
          FormField({ label: t('age'), name: 'age', type: 'number', value: formData.age }, D),
          FormSelect({ label: t('gender'), name: 'gender', value: formData.gender, options: [
            { value: 'male', label: t('male') },
            { value: 'female', label: t('female') }
          ]}, D),
          FormField({ label: t('address'), name: 'address', type: 'text', value: formData.address, fullWidth: true }, D),
          FormField({ label: t('diagnosis'), name: 'diagnosis', type: 'text', value: formData.diagnosis, fullWidth: true }, D)
        ]);
      }

      function AppointmentForm(formData, db, D) {
        return D.Containers.Div({ attrs: { class: 'form-grid' } }, [
          FormField({ label: t('patient') + ' *', name: 'patientName', type: 'text', value: formData.patientName, required: true }, D),
          FormField({ label: t('date') + ' *', name: 'date', type: 'date', value: formData.date, required: true }, D),
          FormField({ label: t('time') + ' *', name: 'time', type: 'time', value: formData.time, required: true }, D),
          FormField({ label: t('service'), name: 'service', type: 'text', value: formData.service }, D),
          FormField({ label: t('therapist'), name: 'therapist', type: 'text', value: formData.therapist }, D),
          FormField({ label: t('duration'), name: 'duration', type: 'number', value: formData.duration || 60 }, D),
          FormField({ label: t('price'), name: 'price', type: 'number', value: formData.price || 300 }, D)
        ]);
      }

      function SessionForm(formData, db, D) {
        return D.Containers.Div({ attrs: { class: 'form-grid' } }, [
          FormField({ label: t('patient') + ' *', name: 'patientName', type: 'text', value: formData.patientName, required: true }, D),
          FormField({ label: t('date') + ' *', name: 'date', type: 'date', value: formData.date, required: true }, D),
          FormField({ label: t('service'), name: 'service', type: 'text', value: formData.service }, D),
          FormField({ label: t('therapist'), name: 'therapist', type: 'text', value: formData.therapist }, D),
          FormField({ label: t('duration'), name: 'duration', type: 'number', value: formData.duration || 60 }, D),
          FormField({ label: t('price'), name: 'price', type: 'number', value: formData.price || 300 }, D),
          FormField({ label: t('nextSession'), name: 'nextSession', type: 'date', value: formData.nextSession }, D),
          FormTextarea({ label: t('notes'), name: 'notes', value: formData.notes, fullWidth: true }, D)
        ]);
      }

      function StaffForm(formData, D) {
        return D.Containers.Div({ attrs: { class: 'form-grid' } }, [
          FormField({ label: t('name') + ' *', name: 'name', type: 'text', value: formData.name, required: true }, D),
          FormField({ label: t('role'), name: 'role', type: 'text', value: formData.role }, D),
          FormField({ label: t('specialization'), name: 'specialization', type: 'text', value: formData.specialization, fullWidth: true }, D),
          FormField({ label: t('phone'), name: 'phone', type: 'tel', value: formData.phone }, D),
          FormField({ label: t('email'), name: 'email', type: 'email', value: formData.email }, D),
          FormField({ label: t('joinDate'), name: 'joinDate', type: 'date', value: formData.joinDate }, D)
        ]);
      }

      function ServiceForm(formData, D) {
        return D.Containers.Div({ attrs: { class: 'form-grid' } }, [
          FormField({ label: t('serviceName') + ' *', name: 'name', type: 'text', value: formData.name, required: true, fullWidth: true }, D),
          FormField({ label: t('category'), name: 'category', type: 'text', value: formData.category }, D),
          FormField({ label: t('duration'), name: 'duration', type: 'number', value: formData.duration || 60 }, D),
          FormField({ label: t('price'), name: 'price', type: 'number', value: formData.price || 300 }, D)
        ]);
      }

      // Helper Components
      function FormField({ label, name, type, value, required, fullWidth }, D) {
        return D.Containers.Div({ attrs: { class: fullWidth ? 'form-field form-field-full' : 'form-field' } }, [
          D.Forms.Label({ attrs: { for: name } }, [label]),
          D.Inputs.Input({
            attrs: {
              type: type || 'text',
              name: name,
              id: name,
              value: value || '',
              required: required || false,
              'data-m-gkey': 'form:input',
              class: 'form-input'
            }
          })
        ]);
      }

      function FormSelect({ label, name, value, options }, D) {
        return D.Containers.Div({ attrs: { class: 'form-field' } }, [
          D.Forms.Label({ attrs: { for: name } }, [label]),
          D.Inputs.Select({
            attrs: {
              name: name,
              id: name,
              'data-m-gkey': 'form:input',
              class: 'form-input'
            }
          }, options.map(opt =>
            D.Inputs.Option({
              attrs: {
                value: opt.value,
                selected: value === opt.value
              }
            }, [opt.label])
          ))
        ]);
      }

      function FormTextarea({ label, name, value, fullWidth }, D) {
        return D.Containers.Div({ attrs: { class: fullWidth ? 'form-field form-field-full' : 'form-field' } }, [
          D.Forms.Label({ attrs: { for: name } }, [label]),
          D.Inputs.Textarea({
            attrs: {
              name: name,
              id: name,
              'data-m-gkey': 'form:input',
              class: 'form-input',
              rows: '4'
            }
          }, [value || ''])
        ]);
      }

      // Main App Body
      M.app.setBody(function(stateWrapper, D) {
        const state = stateWrapper;

        return D.Containers.Div({ attrs: { class: tw`flex min-h-screen ${token('surface')}` } }, [
          Sidebar(state, D),
          MainContent(state, D),
          ModalForm(state, D)
        ]);
      });

      // Create and Mount App
      const app = M.app.createApp(db, orders);
      app.mount('#app');

      console.log('ERP Dashboard loaded successfully!');
    })();
  </script>
</body>
</html>
