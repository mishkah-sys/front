<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DNA - 3D Weight Viewer</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #0a0e27;
            color: #e0e6ed;
            overflow: hidden;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        .panel {
            position: fixed;
            background: rgba(10, 14, 39, 0.95);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 12px;
            padding: 20px;
            z-index: 1000;
        }

        #controls {
            top: 20px;
            left: 20px;
            width: 250px;
        }

        #layer-selector {
            top: 20px;
            right: 20px;
            width: 300px;
            max-height: 80vh;
            overflow-y: auto;
        }

        #stats {
            bottom: 20px;
            left: 20px;
            font-size: 0.9rem;
        }

        h3 {
            margin-bottom: 15px;
            color: #667eea;
            font-size: 1.1rem;
        }

        button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .layer-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            border-right: 3px solid transparent;
        }

        .layer-item:hover {
            background: rgba(102, 126, 234, 0.2);
            border-right-color: #667eea;
            transform: translateX(-5px);
        }

        .layer-item.active {
            background: rgba(102, 126, 234, 0.3);
            border-right-color: #764ba2;
        }

        .layer-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .layer-info {
            font-size: 0.85rem;
            color: #a0aec0;
        }

        input[type="range"] {
            width: 100%;
            margin: 10px 0;
        }

        label {
            display: block;
            margin-top: 10px;
            color: #a0aec0;
            font-size: 0.9rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }

        .stat-label {
            color: #a0aec0;
        }

        .stat-value {
            font-weight: 600;
            color: #e0e6ed;
        }

        #loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5rem;
            z-index: 2000;
        }
    </style>
</head>

<body>
    <div id="loading">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    <div id="canvas-container"></div>

    <!-- Controls -->
    <div id="controls" class="panel">
        <h3>âš¡ Ø§Ù„ØªØ­ÙƒÙ…</h3>
        <button onclick="toggleWireframe()">ğŸ”² Wireframe</button>
        <button onclick="resetCamera()">ğŸ¯ Reset Camera</button>
        <button onclick="toggleRotation()">ğŸ”„ Auto Rotate</button>

        <label>Subsample (Ø£Ù‚Ù„ = ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±):</label>
        <input type="range" id="subsample" min="1" max="20" value="10">
        <span id="subsample-value">10</span>

        <label>Height Scale (Ø§Ø±ØªÙØ§Ø¹):</label>
        <input type="range" id="height-scale" min="1" max="20" value="5">
        <span id="height-scale-value">5</span>
    </div>

    <!-- Layer Selector -->
    <div id="layer-selector" class="panel">
        <h3>ğŸ“Š Ø§Ù„Ø·Ø¨Ù‚Ø§Øª</h3>
        <input type="text" id="layer-search" placeholder="Ø§Ø¨Ø­Ø«..."
            style="width: 100%; padding: 8px; margin-bottom: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: white;">
        <div id="layers-list">Ø§Ø®ØªØ± Ù†Ù…ÙˆØ°Ø¬...</div>
    </div>

    <!-- Stats -->
    <div id="stats" class="panel">
        <div class="stat-row">
            <span class="stat-label">Layer:</span>
            <span class="stat-value" id="stat-layer">-</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Shape:</span>
            <span class="stat-value" id="stat-shape">-</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Min:</span>
            <span class="stat-value" id="stat-min">-</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Max:</span>
            <span class="stat-value" id="stat-max">-</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Mean:</span>
            <span class="stat-value" id="stat-mean">-</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Vertices:</span>
            <span class="stat-value" id="stat-vertices">-</span>
        </div>
    </div>

    <script>
        // ============================
        // Three.js Setup
        // ============================

        let scene, camera, renderer, controls;
        let currentMesh = null;
        let isWireframe = false;
        let autoRotate = false;
        let currentModel = null;
        let currentLayer = null;
        let allLayers = [];

        function initThreeJS() {
            // Scene
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x0a0e27);
            scene.fog = new THREE.Fog(0x0a0e27, 20, 100);

            // Camera
            camera = new THREE.PerspectiveCamera(
                60,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.set(15, 12, 15);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.getElementById('canvas-container').appendChild(renderer.domElement);

            // Controls
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 5;
            controls.maxDistance = 100;

            // Lights
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const dirLight1 = new THREE.DirectionalLight(0xffffff, 0.6);
            dirLight1.position.set(20, 30, 20);
            scene.add(dirLight1);

            const dirLight2 = new THREE.DirectionalLight(0x667eea, 0.3);
            dirLight2.position.set(-20, 10, -20);
            scene.add(dirLight2);

            // Grid
            const gridHelper = new THREE.GridHelper(30, 30, 0x667eea, 0x222244);
            scene.add(gridHelper);

            // Axes
            const axesHelper = new THREE.AxesHelper(8);
            scene.add(axesHelper);

            // Window resize
            window.addEventListener('resize', onWindowResize);

            // Range inputs
            document.getElementById('subsample').addEventListener('input', (e) => {
                document.getElementById('subsample-value').textContent = e.target.value;
                if (currentLayer) reloadLayer();
            });

            document.getElementById('height-scale').addEventListener('input', (e) => {
                const value = e.target.value;
                document.getElementById('height-scale-value').textContent = value;
                if (currentMesh) {
                    currentMesh.scale.y = value / 5;
                }
            });

            // Animation
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);

            if (autoRotate && currentMesh) {
                currentMesh.rotation.y += 0.003;
            }

            controls.update();
            renderer.render(scene, camera);
        }

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // ============================
        // Load Data
        // ============================

        async function loadLayers(modelId) {
            currentModel = modelId;

            try {
                const response = await fetch(`/api/weights/${modelId}/layers`);
                const data = await response.json();

                allLayers = data.layers;
                renderLayersList(allLayers);

                // Load first layer automatically
                if (allLayers.length > 0) {
                    await loadLayer(allLayers[0].name);
                }
            } catch (error) {
                console.error('Error loading layers:', error);
                alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø§Øª');
            }
        }

        function renderLayersList(layers) {
            const layersList = document.getElementById('layers-list');
            layersList.innerHTML = layers.map(layer => `
                <div class="layer-item" onclick="loadLayer('${layer.name}')" data-name="${layer.name}">
                    <div class="layer-name">${layer.name}</div>
                    <div class="layer-info">${layer.shape.join(' Ã— ')}</div>
                </div>
            `).join('');
        }

        async function loadLayer(layerName) {
            currentLayer = layerName;
            document.getElementById('loading').style.display = 'block';

            try {
                const subsample = document.getElementById('subsample').value;
                const heightScale = document.getElementById('height-scale').value;

                const response = await fetch(
                    `/api/weights/${currentModel}/layer/${layerName}/3d?subsample=${subsample}&height_scale=${heightScale}`
                );
                const data = await response.json();

                // Remove old mesh
                if (currentMesh) {
                    scene.remove(currentMesh);
                }

                // Create geometry
                const geometry = new THREE.BufferGeometry();

                // Vertices
                const vertices = new Float32Array(data.vertices.flat());
                geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));

                // Colors
                const colors = new Float32Array(data.colors.flat());
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));

                // Indices
                const indices = new Uint32Array(data.indices.flat());
                geometry.setIndex(new THREE.BufferAttribute(indices, 1));

                // Normals
                geometry.computeVertexNormals();

                // Material
                const material = new THREE.MeshPhongMaterial({
                    vertexColors: true,
                    shininess: 50,
                    wireframe: isWireframe,
                    side: THREE.DoubleSide,
                    flatShading: false
                });

                // Mesh
                currentMesh = new THREE.Mesh(geometry, material);
                currentMesh.position.set(-5, 0, -5);
                scene.add(currentMesh);

                // Update stats
                document.getElementById('stat-layer').textContent = layerName;
                document.getElementById('stat-shape').textContent = data.stats.original_shape.join(' Ã— ');
                document.getElementById('stat-min').textContent = data.stats.min.toFixed(4);
                document.getElementById('stat-max').textContent = data.stats.max.toFixed(4);
                document.getElementById('stat-mean').textContent = data.stats.mean.toFixed(4);
                document.getElementById('stat-vertices').textContent = data.stats.vertices_count;

                // Highlight active layer
                document.querySelectorAll('.layer-item').forEach(el => {
                    el.classList.toggle('active', el.dataset.name === layerName);
                });

            } catch (error) {
                console.error('Error loading layer:', error);
                alert('ÙØ´Ù„ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ø¨Ù‚Ø©');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        async function reloadLayer() {
            if (currentLayer) {
                await loadLayer(currentLayer);
            }
        }

        // ============================
        // Controls
        // ============================

        function toggleWireframe() {
            isWireframe = !isWireframe;
            if (currentMesh) {
                currentMesh.material.wireframe = isWireframe;
            }
        }

        function resetCamera() {
            camera.position.set(15, 12, 15);
            controls.target.set(0, 0, 0);
            controls.update();
        }

        function toggleRotation() {
            autoRotate = !autoRotate;
        }

        // Layer search
        document.getElementById('layer-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = allLayers.filter(layer =>
                layer.name.toLowerCase().includes(query)
            );
            renderLayersList(filtered);
        });

        // ============================
        // Initialize
        // ============================

        initThreeJS();

        // Load first model (tinybert or first loaded)
        fetch('/api/weights/tinybert/loaded-models')
            .then(r => r.json())
            .then(data => {
                // Try to load tinybert, fallback to first loaded
                loadLayers('tinybert').catch(() => {
                    alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ù†Ù…ÙˆØ°Ø¬ Ø£ÙˆÙ„Ø§Ù‹ Ù…Ù† Play Store');
                });
            });
    </script>
</body>

</html>