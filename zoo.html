<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸª Tiny AI Play Store | DNA</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Inter:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-dark: #0a0a0f;
            --bg-card: #12121a;
            --bg-card-hover: #1a1a25;
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-green: #22c55e;
            --accent-orange: #f59e0b;
            --accent-red: #ef4444;
            --text-primary: #ffffff;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #1e293b;
            --gradient-1: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-2: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: linear-gradient(180deg, rgba(99, 102, 241, 0.1) 0%, transparent 100%);
            border-bottom: 1px solid var(--border-color);
            padding: 1.5rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
            backdrop-filter: blur(10px);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo-icon {
            font-size: 2.5rem;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .logo-text p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .stats-bar {
            display: flex;
            gap: 2rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        /* Main Content */
        .main {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* Section */
        .section {
            margin-bottom: 3rem;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-title .tier-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.75rem;
            border-radius: 999px;
            background: var(--gradient-1);
        }

        /* Model Grid */
        .model-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        /* Model Card */
        .model-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .model-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--accent-primary);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.15);
        }

        .model-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .model-card:hover::before {
            opacity: 1;
        }

        .model-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .model-name {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .model-family {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .model-status {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            padding: 0.35rem 0.75rem;
            border-radius: 999px;
            background: rgba(100, 116, 139, 0.2);
            color: var(--text-secondary);
        }

        .model-status.ready {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }

        .model-status.downloading {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
        }

        .model-status.loading {
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
        }

        .model-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .model-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 1rem;
            line-height: 1.5;
        }

        .model-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .meta-tag {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-primary);
        }

        .meta-tag.modality {
            background: rgba(139, 92, 246, 0.1);
            color: var(--accent-secondary);
        }

        .model-size {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .size-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .size-value {
            font-weight: 600;
            font-size: 1rem;
        }

        .size-label {
            color: var(--text-muted);
            font-size: 0.8rem;
        }

        .model-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }

        .btn-primary:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Chat Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .chat-area {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 300px;
        }

        .chat-message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 12px;
            line-height: 1.5;
        }

        .chat-message.user {
            background: var(--gradient-1);
            align-self: flex-end;
        }

        .chat-message.assistant {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            align-self: flex-start;
        }

        .chat-input-area {
            padding: 1.5rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 1rem;
        }

        .chat-input {
            flex: 1;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            color: var(--text-primary);
            font-family: inherit;
            font-size: 1rem;
            resize: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .chat-send {
            padding: 1rem 1.5rem;
            background: var(--gradient-1);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .chat-send:hover {
            transform: scale(1.05);
        }

        /* Loading States */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }

            .stats-bar {
                width: 100%;
                justify-content: space-around;
            }

            .model-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Task Type Pills */
        .task-pills {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
            margin-bottom: 0.75rem;
        }

        .task-pill {
            font-size: 0.65rem;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            background: rgba(34, 197, 94, 0.1);
            color: var(--accent-green);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Filter Bar */
        .filter-bar {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 999px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            font-size: 0.9rem;
        }

        .filter-btn:hover,
        .filter-btn.active {
            background: var(--gradient-1);
            border-color: transparent;
            color: white;
        }
    </style>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <span class="logo-icon">ğŸª</span>
                <div class="logo-text">
                    <h1>Tiny AI Play Store</h1>
                    <p>Ù†Ù…Ø§Ø°Ø¬ Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ØµØºÙŠØ±Ø© ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ</p>
                </div>
            </div>
            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="total-models">--</div>
                    <div class="stat-label">Ù†Ù…ÙˆØ°Ø¬</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="loaded-models">0</div>
                    <div class="stat-label">Ù…Ø­Ù…Ù‘Ù„</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="memory-usage">0</div>
                    <div class="stat-label">MB Ø°Ø§ÙƒØ±Ø©</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <!-- Filter Bar -->
        <div class="filter-bar">
            <button class="filter-btn active" data-filter="all">ğŸ“¦ Ø§Ù„ÙƒÙ„</button>
            <button class="filter-btn" data-filter="text">ğŸ”¤ Ù†Øµ</button>
            <button class="filter-btn" data-filter="vision">ğŸ‘ï¸ ØµÙˆØ±</button>
            <button class="filter-btn" data-filter="audio">ğŸ”Š ØµÙˆØª</button>
            <button class="filter-btn" data-filter="tier-1">â­ Tier 1</button>
        </div>

        <!-- Tier 1 Section -->
        <section class="section" id="tier-1-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span>â­ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ù‡Ù†Ø§</span>
                    <span class="tier-badge">Tier 1</span>
                </h2>
            </div>
            <div class="model-grid" id="tier-1-grid"></div>
        </section>

        <!-- Tier 2 Section -->
        <section class="section" id="tier-2-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span>ğŸ‘ï¸ Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„ØµÙˆØª</span>
                    <span class="tier-badge" style="background: var(--gradient-2)">Tier 2</span>
                </h2>
            </div>
            <div class="model-grid" id="tier-2-grid"></div>
        </section>

        <!-- Tier 3 Section -->
        <section class="section" id="tier-3-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span>ğŸ§ª Ù…ØªØ®ØµØµØ©</span>
                    <span class="tier-badge" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%)">Tier
                        3</span>
                </h2>
            </div>
            <div class="model-grid" id="tier-3-grid"></div>
        </section>
    </main>

    <!-- Chat Modal -->
    <div class="modal-overlay" id="chat-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-model-name">DistilGPT-2</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="chat-area" id="chat-area">
                <div class="chat-message assistant">
                    ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! ÙƒÙŠÙ ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒØŸ
                </div>
            </div>
            <div class="chat-input-area">
                <textarea class="chat-input" id="chat-input" rows="1" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..."></textarea>
                <button class="chat-send" onclick="sendMessage()">Ø¥Ø±Ø³Ø§Ù„</button>
            </div>
        </div>
    </div>

    <!-- Download Progress Modal -->
    <div class="modal-overlay" id="download-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“¥ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
                <button class="modal-close" onclick="closeDownloadModal()">Ã—</button>
            </div>
            <div style="padding: 20px;">
                <div id="download-model-name" style="font-size: 1.2rem; margin-bottom: 10px; font-weight: 600;"></div>

                <!-- Progress Bar -->
                <div
                    style="background: rgba(255,255,255,0.1); height: 30px; border-radius: 15px; overflow: hidden; margin: 20px 0;">
                    <div id="download-progress-bar"
                        style="height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); width: 0%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.9rem; font-weight: 600;">
                        0%
                    </div>
                </div>

                <!-- Stats -->
                <div
                    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0; text-align: center;">
                    <div>
                        <div style="color: #a0aec0; font-size: 0.85rem;">Ø§Ù„Ù…Ø­ Ù…Ù‘Ù„</div>
                        <div id="download-size" style="font-size: 1.1rem; font-weight: 600;">0 MB</div>
                    </div>
                    <div>
                        <div style="color: #a0aec0; font-size: 0.85rem;">Ø§Ù„Ø³Ø±Ø¹Ø©</div>
                        <div id="download-speed" style="font-size: 1.1rem; font-weight: 600;">0 MB/s</div>
                    </div>
                    <div>
                        <div style="color: #a0aec0; font-size: 0.85rem;">Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                        <div id="download-eta" style="font-size: 1.1rem; font-weight: 600;">--</div>
                    </div>
                </div>

                <!-- Logs -->
                <div style="margin-top: 20px;">
                    <div style="color: #a0aec0; font-size: 0.85rem; margin-bottom: 8px;">Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„:</div>
                    <div id="download-logs"
                        style="background: rgba(0,0,0,0.3); padding: 15px; border-radius: 8px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; line-height: 1.6;">
                        <div style="color: #48bb78;">â— Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script>
        // ====== Authentication Check =======
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = '/login.html';
        }
        // Add token to all requests
        const authHeaders = {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        };

        const API_BASE = '/api';
        let currentModel = null;
        let catalog = { text: [], vision: [], audio: [], multimodal: [] };

        // Fetch catalog on load
        async function loadCatalog() {
            try {
                const response = await fetch(`${API_BASE}/zoo/catalog`);
                const data = await response.json();
                catalog = data;

                // Update stats
                document.getElementById('total-models').textContent = data.stats.total_models;

                // Render grids
                renderModels();

                // Update loaded models
                updateLoadedStats();
            } catch (error) {
                console.error('Failed to load catalog:', error);
            }
        }

        // Render model cards
        function renderModels() {
            const allModels = [
                ...catalog.text,
                ...catalog.vision,
                ...catalog.audio,
                ...catalog.multimodal
            ];

            // Tier 1
            const tier1 = allModels.filter(m => m.tier === 1);
            document.getElementById('tier-1-grid').innerHTML = tier1.map(createModelCard).join('');

            // Tier 2
            const tier2 = allModels.filter(m => m.tier === 2);
            document.getElementById('tier-2-grid').innerHTML = tier2.map(createModelCard).join('');

            // Tier 3
            const tier3 = allModels.filter(m => m.tier === 3);
            document.getElementById('tier-3-grid').innerHTML = tier3.map(createModelCard).join('');
        }

        // Create model card HTML
        function createModelCard(model) {
            const statusClass = model.status === 'ready' ? 'ready' :
                model.status === 'downloading' ? 'downloading' :
                    model.status === 'loading' ? 'loading' : '';

            const statusText = {
                'not_downloaded': 'ØºÙŠØ± Ù…Ø­Ù…Ù‘Ù„',
                'downloading': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...',
                'downloaded': 'Ù…Ø­Ù…Ù‘Ù„',
                'loading': 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ´ØºÙŠÙ„...',
                'ready': 'Ø¬Ø§Ù‡Ø²',
                'error': 'Ø®Ø·Ø£'
            }[model.status] || model.status;

            const modalityIcon = {
                'text': 'ğŸ”¤',
                'vision': 'ğŸ‘ï¸',
                'audio': 'ğŸ”Š',
                'multimodal': 'ğŸ¨'
            }[model.modality] || 'ğŸ“¦';

            return `
                <div class="model-card" data-model-id="${model.id}" data-modality="${model.modality}" data-tier="${model.tier}">
                    <div class="model-header">
                        <div>
                            <div class="model-name">${model.name}</div>
                            <div class="model-family">${model.family}</div>
                        </div>
                        <div class="model-status ${statusClass}">
                            <span class="model-status-dot"></span>
                            <span>${statusText}</span>
                        </div>
                    </div>
                    <div class="model-description">${model.description}</div>
                    <div class="task-pills">
                        ${model.tasks.map(t => `<span class="task-pill">${t}</span>`).join('')}
                    </div>
                    <div class="model-meta">
                        <span class="meta-tag modality">${modalityIcon} ${model.modality}</span>
                        <span class="meta-tag">${model.architecture}</span>
                        ${model.requires_gpu ? '<span class="meta-tag" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;">GPU</span>' : '<span class="meta-tag" style="background: rgba(34, 197, 94, 0.1); color: #22c55e;">CPU</span>'}
                    </div>
                    <div class="model-size">
                        <div class="size-info">
                            <span class="size-value">${model.params_millions}M</span>
                            <span class="size-label">params</span>
                        </div>
                        <div class="model-actions">
                            ${model.status === 'ready' || model.status === 'downloaded' ?
                    `<button class="btn btn-primary" onclick="tryModel('${model.id}')">Ø¬Ø±Ù‘Ø¨</button>` :
                    model.status === 'not_downloaded' ?
                        `<button class="btn btn-primary" onclick="downloadModel('${model.id}')">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„</button>` :
                        `<button class="btn btn-secondary" disabled><span class="loading-spinner"></span></button>`
                }
                        </div>
                    </div>
                </div>
            `;
        }

        // Download model
        async function downloadModel(modelId) {
            try {
                // Find model info
                const allModels = [...catalog.text, ...catalog.vision, ...catalog.audio, ...catalog.multimodal];
                const model = allModels.find(m => m.id === modelId);

                // Open download modal
                document.getElementById('download-model-name').textContent = model ? model.name : modelId;
                document.getElementById('download-modal').classList.add('active');

                // Reset progress UI
                updateDownloadProgress(0, 0, 0, 0, '--');
                addDownloadLog('â— Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€Ø§Ù„Ø®Ø§Ø¯Ù…...');

                //Update UI to show downloading
                updateModelStatus(modelId, 'downloading');

                const response = await fetch(`${API_BASE}/zoo/download`, {
                    method: 'POST',
                    headers: authHeaders,
                    body: JSON.stringify({ model_id: modelId })
                });

                const result = await response.json();

                if (response.ok) {
                    // Start polling for progress
                    addDownloadLog(`â— Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù…ÙŠÙ„...`);
                    pollDownloadProgress(modelId);
                } else {
                    // Error occurred
                    updateModelStatus(modelId, 'error');
                    addDownloadLog(`âœ— ÙØ´Ù„: ${result.detail || result.message}`, 'error');
                }
            } catch (error) {
                console.error('Download failed:', error);
                updateModelStatus(modelId, 'error');
                addDownloadLog(`âœ— Ø®Ø·Ø£: ${error.message}`, 'error');
            }
        }

        // Update download progress UI
        function updateDownloadProgress(percent, downloaded_mb, total_mb, speed_mbps, eta) {
            document.getElementById('download-progress-bar').style.width = `${percent}%`;
            document.getElementById('download-progress-bar').textContent = `${Math.round(percent)}%`;
            document.getElementById('download-size').textContent = `${downloaded_mb.toFixed(1)} MB / ${total_mb.toFixed(1)} MB`;
            document.getElementById('download-speed').textContent = `${speed_mbps.toFixed(2)} MB/s`;
            document.getElementById('download-eta').textContent = eta;
        }

        // Poll download progress
        async function pollDownloadProgress(modelId) {
            let lastPercent = 0;

            const poll = async () => {
                try {
                    const response = await fetch(`${API_BASE}/zoo/models/${modelId}`, {
                        headers: authHeaders
                    });
                    const data = await response.json();

                    // Update model status
                    updateModelStatus(modelId, data.status);

                    // If download_progress exists, update UI
                    if (data.download_progress) {
                        const progress = data.download_progress;
                        const percent = progress.percent || 0;
                        const downloaded = progress.downloaded_mb || 0;
                        const total = progress.total_mb || 0;
                        const speed = progress.speed_mbps || 0;

                        // Calculate ETA
                        let eta = '--';
                        if (progress.eta_seconds && progress.eta_seconds > 0) {
                            const mins = Math.floor(progress.eta_seconds / 60);
                            const secs = Math.round(progress.eta_seconds % 60);
                            eta = `${mins}:${secs.toString().padStart(2, '0')}`;
                        }

                        updateDownloadProgress(percent, downloaded, total, speed, eta);

                        // Log progress milestones
                        if (percent > lastPercent + 10) {
                            addDownloadLog(`â¬‡ï¸ ${Math.round(percent)}% - ${downloaded.toFixed(1)} MB`);
                            lastPercent = Math.floor(percent / 10) * 10;
                        }
                    }

                    // Keep polling if still downloading
                    if (data.status === 'downloading') {
                        setTimeout(poll, 1000); // Poll every 1 second
                    } else if (data.status === 'downloaded' || data.status === 'ready') {
                        // Download complete
                        updateDownloadProgress(100, data.download_progress?.total_mb || 0, data.download_progress?.total_mb || 0, 0, '0:00');
                        addDownloadLog(`âœ“ Ø§ÙƒØªÙ…Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„! ${(data.download_progress?.total_mb || 0).toFixed(1)} MB`, 'success');
                        updateLoadedStats();
                    } else if (data.status === 'error') {
                        addDownloadLog(`âœ— ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„`, 'error');
                    }
                } catch (error) {
                    console.error('Poll failed:', error);
                    setTimeout(poll, 3000); // Retry on error
                }
            };
            poll();
        }

        // Update model status in UI
        function updateModelStatus(modelId, status) {
            // Find model in catalog and update
            for (const modality of ['text', 'vision', 'audio', 'multimodal']) {
                const model = catalog[modality].find(m => m.id === modelId);
                if (model) {
                    model.status = status;
                    break;
                }
            }
            renderModels();
        }

        // Update loaded stats
        async function updateLoadedStats() {
            try {
                const response = await fetch(`${API_BASE}/zoo/loaded`);
                const data = await response.json();

                document.getElementById('loaded-models').textContent = data.loaded_models.length;
                document.getElementById('memory-usage').textContent = Math.round(data.total_memory_mb);
            } catch (error) {
                console.error('Failed to get loaded stats:', error);
            }
        }

        // Try model (open chat)
        async function tryModel(modelId) {
            // Find model
            let model = null;
            for (const modality of ['text', 'vision', 'audio', 'multimodal']) {
                model = catalog[modality].find(m => m.id === modelId);
                if (model) break;
            }

            if (!model) return;

            // If model is downloaded but not loaded in memory, load it first
            if (model.status === 'downloaded') {
                try {
                    updateModelStatus(modelId, 'loading');

                    const response = await fetch(`${API_BASE}/zoo/load/${modelId}`, {
                        method: 'POST'
                    });

                    if (response.ok) {
                        const result = await response.json();
                        updateModelStatus(modelId, result.status);
                        model.status = result.status;
                    } else {
                        alert('ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ù„Ù„Ø°Ø§ÙƒØ±Ø©');
                        updateModelStatus(modelId, 'downloaded');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to load model:', error);
                    alert(`Ø®Ø·Ø£: ${error.message}`);
                    updateModelStatus(modelId, 'downloaded');
                    return;
                }
            }

            currentModel = model;
            document.getElementById('modal-model-name').textContent = model.name;
            document.getElementById('chat-area').innerHTML = `
                <div class="chat-message assistant">
                    ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø£Ù†Ø§ ${model.name}. 
                    ${model.tasks.includes('text-generation') ? 'ÙŠÙ…ÙƒÙ†Ù†ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†ØµÙˆØµ.' : ''}
                    ${model.tasks.includes('text-embeddings') ? 'ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ø¥Ù†Ø´Ø§Ø¡ embeddings Ù„Ù„Ù†ØµÙˆØµ.' : ''}
                </div>
            `;
            document.getElementById('chat-modal').classList.add('active');
        }

        // Close modal
        function closeModal() {
            document.getElementById('chat-modal').classList.remove('active');
            currentModel = null;
        }

        // Close download modal
        function closeDownloadModal() {
            document.getElementById('download-modal').classList.remove('active');
        }

        // Add download log entry
        function addDownloadLog(message, type = 'info') {
            const logsDiv = document.getElementById('download-logs');
            const timestamp = new Date().toLocaleTimeString('ar-EG');
            const color = type === 'error' ? '#fc8181' : type === 'success' ? '#48bb78' : '#e0e6ed';

            const logEntry = document.createElement('div');
            logEntry.style.color = color;
            logEntry.textContent = `[${timestamp}] ${message}`;

            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        // Send message
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if (!message || !currentModel) return;

            // Add user message
            addChatMessage(message, 'user');
            input.value = '';

            // Determine task
            const isGeneration = currentModel.tasks.includes('text-generation');

            try {
                if (isGeneration) {
                    // Text generation
                    addChatMessage('...', 'assistant', 'loading-message');

                    const response = await fetch(`${API_BASE}/zoo/generate`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_id: currentModel.id,
                            prompt: message,
                            max_length: 100,
                            temperature: 0.8
                        })
                    });

                    const result = await response.json();

                    // Remove loading message
                    document.querySelector('.loading-message')?.remove();

                    if (result.success) {
                        addChatMessage(result.output, 'assistant');
                    } else {
                        addChatMessage(`âŒ ${result.error}`, 'assistant');
                    }
                } else {
                    // Embeddings
                    addChatMessage('Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù€ embeddings...', 'assistant', 'loading-message');

                    const response = await fetch(`${API_BASE}/zoo/embed`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            model_id: currentModel.id,
                            texts: [message]
                        })
                    });

                    const result = await response.json();

                    document.querySelector('.loading-message')?.remove();

                    if (result.success) {
                        const dims = result.output[0].length;
                        const sample = result.output[0].slice(0, 5).map(v => v.toFixed(4)).join(', ');
                        addChatMessage(`âœ… Embedding (${dims} dims)\nØ£ÙˆÙ„ 5 Ù‚ÙŠÙ…: [${sample}, ...]`, 'assistant');
                    } else {
                        addChatMessage(`âŒ ${result.error}`, 'assistant');
                    }
                }
            } catch (error) {
                document.querySelector('.loading-message')?.remove();
                addChatMessage(`âŒ Ø®Ø·Ø£: ${error.message}`, 'assistant');
            }
        }

        // Add chat message
        function addChatMessage(text, role, className = '') {
            const chatArea = document.getElementById('chat-area');
            const div = document.createElement('div');
            div.className = `chat-message ${role} ${className}`;
            div.textContent = text;
            chatArea.appendChild(div);
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        // Filter buttons
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                const filter = btn.dataset.filter;
                const cards = document.querySelectorAll('.model-card');
                const sections = document.querySelectorAll('.section');

                if (filter === 'all') {
                    cards.forEach(c => c.style.display = '');
                    sections.forEach(s => s.style.display = '');
                } else if (filter.startsWith('tier-')) {
                    const tier = filter.split('-')[1];
                    sections.forEach(s => {
                        s.style.display = s.id === `tier-${tier}-section` ? '' : 'none';
                    });
                    cards.forEach(c => c.style.display = '');
                } else {
                    sections.forEach(s => s.style.display = '');
                    cards.forEach(c => {
                        c.style.display = c.dataset.modality === filter ? '' : 'none';
                    });
                }
            });
        });

        // Enter to send
        document.getElementById('chat-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Load on start
        loadCatalog();

        // Periodic refresh
        setInterval(updateLoadedStats, 5000);
    </script>
</body>

</html>